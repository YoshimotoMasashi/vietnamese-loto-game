<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LÃ´ TÃ´ Global - Definitive Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        [v-cloak] { display: none; }
        .cell { aspect-ratio: 1/1; font-weight: 800; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0; font-size: 0.9rem; background: white; transition: all 0.2s; position: relative; cursor: pointer; }
        .marked::after { content: ''; position: absolute; width: 75%; height: 75%; background-color: rgba(239, 68, 68, 0.85); border-radius: 50%; z-index: 10; animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cell-num { z-index: 20; }
        .marked .cell-num { color: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .history-item { width: 36px; height: 36px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #334155; font-weight: 800; font-size: 0.85rem; color: #cbd5e1; border: 1px solid #475569; }
        .history-latest { background: #ef4444; color: white; border-color: #ef4444; transform: scale(1.1); box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    <div id="app" v-cloak class="min-h-screen max-w-md mx-auto flex flex-col bg-white shadow-2xl relative overflow-hidden text-slate-800">
        
        <div class="fixed top-24 left-0 right-0 z-[60] px-6 pointer-events-none text-center">
            <div v-for="log in logs" :key="log.id" class="inline-block bg-black/80 text-white text-xs font-bold py-3 px-6 rounded-full shadow-2xl mb-2 animate-pop">
                {{ log.message }}
            </div>
        </div>

        <header class="p-3 bg-white border-b flex justify-between items-center sticky top-0 z-40 h-20 shadow-sm">
            <button v-if="gameState !== 'HOME'" @click="confirmQuit" class="flex flex-col items-center justify-center min-w-[60px] text-slate-500 hover:text-red-500 transition">
                <i class="fas fa-home text-xl"></i>
                <span class="text-[10px] font-black uppercase mt-1">{{ t.homeBtn }}</span>
            </button>
            <div v-else class="w-10"></div>

            <select v-model="currentLang" @change="handleLangChange" class="text-sm font-black bg-slate-50 border-2 rounded-xl px-2 py-2 outline-none border-slate-200">
                <option v-for="(l, code) in i18n" :key="code" :value="code">{{ l.langName }}</option>
            </select>
            
            <button @click="openWalletModal" class="flex items-center bg-green-50 px-4 py-2 rounded-2xl border-2 border-green-100 active:scale-95 transition">
                <div class="flex flex-col items-end mr-3">
                    <span class="text-[10px] text-green-700 font-black leading-none uppercase tracking-widest">{{ t.walletLabel }}</span>
                    <span class="font-black text-green-600 text-2xl leading-tight">{{ wallet.currency }}{{ wallet.amount.toLocaleString() }}</span>
                </div>
                <i class="fas fa-wallet text-green-400 text-lg"></i>
            </button>
        </header>

        <main class="flex-grow flex flex-col overflow-hidden relative">
            <div v-if="gameState === 'HOME'" class="flex-grow p-8 flex flex-col justify-center space-y-8">
                <div class="text-center">
                    <h1 class="text-7xl font-black text-red-600 italic tracking-tighter drop-shadow-md">LÃ” TÃ”</h1>
                    <p class="text-xs text-slate-400 font-black tracking-[0.5em] uppercase mt-2">{{ t.welcomeMsg }}</p>
                </div>
                <div class="bg-slate-50 p-5 rounded-[2.5rem] border-4 border-slate-100 shadow-inner">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-3 block mb-1">{{ t.playerNameLabel }}</label>
                    <input type="text" v-model="playerName" class="w-full bg-transparent text-2xl font-black px-3 outline-none text-slate-700" :placeholder="t.placeholderName">
                </div>
                <div class="space-y-4">
                    <button @click="initGame('SOLO')" class="w-full bg-slate-900 text-white p-6 rounded-[2rem] flex items-center shadow-2xl active:scale-95 transition">
                        <i class="fas fa-play text-3xl mr-6"></i>
                        <span class="font-black text-xl uppercase italic">{{ t.soloMode }}</span>
                    </button>
                    <button @click="initGame('MULTI')" class="w-full bg-red-600 text-white p-6 rounded-[2rem] flex items-center shadow-2xl active:scale-95 transition">
                        <i class="fas fa-users text-3xl mr-6"></i>
                        <span class="font-black text-xl uppercase italic">{{ t.multiMode }}</span>
                    </button>
                </div>
            </div>

            <div v-else-if="gameState === 'SETUP'" class="flex-grow p-8 space-y-6 overflow-y-auto no-scrollbar">
                <h2 class="text-center font-black text-3xl text-slate-800 italic uppercase border-b-4 border-red-500 inline-block mx-auto pb-1 mb-6 w-full">{{ t.setupTitle }}</h2>
                <div class="space-y-3">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">{{ t.ticketCount }}</label>
                    <div class="grid grid-cols-4 gap-3">
                        <button v-for="n in 4" :key="n" @click="ticketCount = n" :class="ticketCount === n ? 'bg-red-600 text-white scale-105 shadow-xl' : 'bg-slate-100 text-slate-400'" class="py-4 rounded-2xl font-black text-xl transition">{{ n }}</button>
                    </div>
                </div>
                <div class="space-y-3">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">{{ t.drawMethod }}</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="isAuto = true" :class="isAuto ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-100 text-slate-400'" class="py-5 rounded-2xl font-black text-lg transition uppercase">Auto</button>
                        <button @click="isAuto = false" :class="!isAuto ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-100 text-slate-400'" class="py-5 rounded-2xl font-black text-lg transition uppercase">Manual</button>
                    </div>
                </div>
                <div v-if="isAuto" class="space-y-3 bg-slate-50 p-5 rounded-3xl shadow-inner">
                    <div class="flex justify-between items-center"><label class="text-xs font-black text-slate-400 uppercase">{{ t.speedLabel }}</label><span class="text-xl font-black text-red-600">{{ drawInterval }}s</span></div>
                    <input type="range" v-model="drawInterval" min="2" max="10" step="1" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-600">
                </div>
                <div class="space-y-3">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">{{ t.betAmount }}</label>
                    <div class="flex items-center bg-slate-50 p-5 rounded-3xl border-4 border-slate-100 shadow-inner">
                        <span class="font-black text-slate-400 text-2xl mr-4">{{ wallet.currency }}</span>
                        <input type="number" v-model.number="betAmount" class="bg-transparent text-3xl font-black w-full outline-none text-slate-800">
                    </div>
                </div>
                <button @click="startGame" class="w-full bg-red-600 text-white py-6 rounded-[2rem] font-black text-3xl shadow-2xl mt-6 active:translate-y-2 transition uppercase italic">
                    {{ t.startBtn }}
                </button>
            </div>

            <div v-else class="flex-grow flex flex-col h-full overflow-hidden bg-slate-50">
                <div class="bg-slate-900 text-white p-5 shadow-2xl z-10 border-b-2 border-white/5">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-5">
                            <div class="w-24 h-24 bg-white rounded-[2rem] flex items-center justify-center text-slate-900 text-6xl font-black border-b-[10px] border-red-600 animate-pop" :key="currentNumber">
                                {{ currentNumber || '--' }}
                            </div>
                            <div>
                                <p class="text-xs text-red-500 font-black italic uppercase tracking-[0.2em]">{{ t.drawnLabel }}</p>
                                <p class="text-4xl font-black tracking-tighter">{{ drawnHistory.length }}<span class="text-lg opacity-30 font-normal ml-1">/90</span></p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-3">
                            <button v-if="mode === 'MULTI'" @click="showShareModal = true" class="bg-red-600 text-[10px] px-4 py-2.5 rounded-2xl font-black shadow-lg flex items-center uppercase active:scale-95 transition">
                                <i class="fas fa-qrcode mr-2 text-sm"></i> {{ t.inviteBtn }}
                            </button>
                            <div class="flex gap-3">
                                <div class="flex flex-col items-center">
                                    <button v-if="isAuto" @click="togglePause" class="w-14 h-14 rounded-full bg-white text-slate-900 flex items-center justify-center shadow-2xl active:scale-90 transition">
                                        <i :class="isPaused ? 'fas fa-play ml-1 text-xl' : 'fas fa-pause text-xl'"></i>
                                    </button>
                                    <button v-else @click="drawNext" class="w-14 h-14 rounded-full bg-red-600 text-white flex items-center justify-center shadow-2xl active:scale-90 transition">
                                        <i class="fas fa-forward text-xl"></i>
                                    </button>
                                    <span class="text-[9px] font-black mt-2 uppercase opacity-60 tracking-widest">{{ isAuto ? (isPaused ? t.playText : t.pauseText) : t.nextBtn }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 pt-4 border-t border-white/10 overflow-hidden">
                        <div class="flex items-center space-x-3 overflow-x-auto no-scrollbar py-2 px-1">
                            <div v-for="(n, idx) in [...drawnHistory].reverse()" :key="idx" 
                                 class="history-item transition-all duration-300" :class="idx === 0 ? 'history-latest' : 'opacity-70'">
                                {{ n }}
                            </div>
                            <div v-if="drawnHistory.length === 0" class="text-xs text-white/20 font-black italic uppercase tracking-widest py-2">{{ t.historyEmpty }}</div>
                        </div>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto p-4 space-y-6 no-scrollbar">
                    <div v-for="(card, cIdx) in myCards" :key="cIdx" class="bg-white p-3 rounded-3xl shadow-xl border-2 border-slate-200">
                        <div v-for="(row, rIdx) in card" :key="rIdx" class="grid grid-cols-9 gap-1.5 mb-1.5">
                            <div v-for="(num, nIdx) in row" :key="nIdx" 
                                @click="toggleMark(cIdx, rIdx, nIdx)"
                                class="cell rounded-lg" :class="[num === 0 ? 'bg-slate-50/50 border-none opacity-0' : '', isMarked(cIdx, rIdx, nIdx) ? 'marked' : '']">
                                <span class="cell-num">{{ num !== 0 ? num : '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="pt-6 pb-28">
                        <button @click="checkKinh" class="w-full bg-red-600 text-white py-10 rounded-[3rem] font-black text-5xl italic shadow-2xl active:scale-95 transition border-b-[12px] border-red-800">
                            {{ t.kinhBtn }}
                        </button>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-1 right-2 pointer-events-none text-[8px] text-slate-300 font-mono">
                Last Update: 2026-02-09 07:05 / Rev: 5
            </div>
        </main>

        <div v-if="showShareModal" class="fixed inset-0 z-50 flex items-center justify-center p-8 bg-black/90 backdrop-blur-lg animate-pop">
            <div class="bg-white rounded-[3rem] w-full p-10 text-center space-y-8 shadow-2xl border-t-[12px] border-red-600">
                <h3 class="font-black text-3xl italic text-red-600 uppercase">{{ t.inviteTitle }}</h3>
                <div id="qrcode" class="flex justify-center p-6 bg-white rounded-[2rem] border-4 border-slate-100 shadow-inner"></div>
                <div class="grid grid-cols-2 gap-4 pt-2">
                    <button @click="copyLink" class="bg-slate-900 text-white py-5 rounded-2xl font-black text-sm uppercase shadow-lg">{{ t.copyBtn }}</button>
                    <button @click="showShareModal = false" class="bg-slate-100 text-slate-400 py-5 rounded-2xl font-black text-sm uppercase">{{ t.closeBtn }}</button>
                </div>
            </div>
        </div>

        <div v-if="showWalletModal" class="fixed inset-0 z-50 flex items-center justify-center p-8 bg-black/90 backdrop-blur-lg animate-pop">
            <div class="bg-white rounded-[3rem] w-full p-10 space-y-8 shadow-2xl border-t-[12px] border-green-500">
                <h3 class="font-black text-3xl italic text-green-600 uppercase flex items-center justify-center"><i class="fas fa-wallet mr-4"></i>{{ t.walletTitle }}</h3>
                <div class="space-y-5 text-left">
                    <div class="bg-slate-50 p-6 rounded-3xl border-2"><label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1 block">{{ t.curLabel }}</label><input type="text" v-model="tempWallet.currency" class="w-full bg-transparent font-black text-2xl outline-none"></div>
                    <div class="bg-slate-50 p-6 rounded-3xl border-2"><label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1 block">{{ t.balLabel }}</label><input type="number" v-model.number="tempWallet.amount" class="w-full bg-transparent font-black text-4xl outline-none"></div>
                </div>
                <div class="flex gap-4 pt-2">
                    <button @click="showWalletModal = false" class="flex-1 py-5 text-slate-400 font-bold uppercase tracking-widest text-sm">{{ t.cancel }}</button>
                    <button @click="saveWallet" class="flex-1 bg-green-600 text-white py-5 rounded-2xl font-black shadow-xl uppercase tracking-widest text-sm active:scale-95 transition">{{ t.saveBtn }}</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAqKCaLzCoGY6e87gHmeRAAawN5yrVeFcg",
            authDomain: "loto-vn.firebaseapp.com",
            databaseURL: "https://loto-vn-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "loto-vn",
            storageBucket: "loto-vn.firebasestorage.app",
            messagingSenderId: "403754138736",
            appId: "1:403754138736:web:9e8927bf43a86f299bc8b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const i18n = {
            vi: { langName: "Tiáº¿ng Viá»‡t", cur: "â‚«", defWallet: 500000, defBet: 10000, welcomeMsg: "ChÃ o má»«ng", playerNameLabel: "TÃªn ngÆ°á»i chÆ¡i", placeholderName: "Nháº­p tÃªn...", soloMode: "Solo", multiMode: "Multiplayer", setupTitle: "Thiáº¿t láº­p", ticketCount: "Sá»‘ vÃ©", drawMethod: "CÃ¡ch quay", speedLabel: "Tá»‘c Ä‘á»™", betAmount: "Má»©c cÆ°á»£c", startBtn: "Báº®T Äáº¦U", drawnLabel: "Sá»‘ Ä‘Ã£ bá»‘c", nextBtn: "Tiáº¿p theo", playText: "Cháº¡y", pauseText: "Dá»«ng", homeBtn: "Home", historyEmpty: "Trá»‘ng", kinhBtn: "KINH!", winMsg: "CHIáº¾N THáº®NG!", loseMsg: "ChÆ°a Kinh!", walletLabel: "Sá»‘ dÆ°", quitConfirm: "ThoÃ¡t game?", inviteBtn: "Má»i", inviteTitle: "Má»i Tham Gia", copyBtn: "Copy", closeBtn: "ÄÃ³ng", walletTitle: "VÃ­", curLabel: "ÄÆ¡n vá»‹", balLabel: "Sá»‘ dÆ°", cancel: "Há»§y", saveBtn: "LÆ°u", fullMsg: "PhÃ²ng Ä‘áº§y" },
            ja: { langName: "æ—¥æœ¬èªž", cur: "Â¥", defWallet: 3000, defBet: 100, welcomeMsg: "ã‚ˆã†ã“ã", playerNameLabel: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å", placeholderName: "åå‰ã‚’å…¥åŠ›...", soloMode: "ã‚½ãƒ­ãƒ—ãƒ¬ã‚¤", multiMode: "ãƒžãƒ«ãƒãƒ—ãƒ¬ã‚¤", setupTitle: "ã‚²ãƒ¼ãƒ è¨­å®š", ticketCount: "ãƒã‚±ãƒƒãƒˆæžšæ•°", drawMethod: "æŠ½é¸æ–¹æ³•", speedLabel: "è‡ªå‹•ã®é–“éš”", betAmount: "è³­ã‘é‡‘", startBtn: "é–‹å§‹", drawnLabel: "å‡ºãŸæ•°å­—", nextBtn: "æ¬¡ã‚’å¼•ã", playText: "å†é–‹", pauseText: "åœæ­¢", homeBtn: "ãƒ›ãƒ¼ãƒ ", historyEmpty: "å±¥æ­´ãªã—", kinhBtn: "ä¸ŠãŒã‚Šï¼", winMsg: "ãŠã‚ã§ã¨ã†ï¼ä¸ŠãŒã‚Šã§ã™ï¼", loseMsg: "ã¾ã ä¸ŠãŒã£ã¦ã„ã¾ã›ã‚“", walletLabel: "æ®‹é«˜", quitConfirm: "ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ", inviteBtn: "æ‹›å¾…", inviteTitle: "ãƒ«ãƒ¼ãƒ æ‹›å¾…", copyBtn: "ã‚³ãƒ”ãƒ¼", closeBtn: "é–‰ã˜ã‚‹", walletTitle: "ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ", curLabel: "é€šè²¨å˜ä½", balLabel: "æ®‹é«˜è¨­å®š", cancel: "æˆ»ã‚‹", saveBtn: "ä¿å­˜", fullMsg: "æº€å“¡ã§ã™" },
            en: { langName: "English", cur: "$", defWallet: 20, defBet: 1, welcomeMsg: "Welcome", playerNameLabel: "Player Name", placeholderName: "Enter name...", soloMode: "Solo", multiMode: "Multi", setupTitle: "Setup", ticketCount: "Tickets", drawMethod: "Method", speedLabel: "Speed", betAmount: "Bet", startBtn: "START", drawnLabel: "Drawn", nextBtn: "Next", playText: "Play", pauseText: "Pause", homeBtn: "Home", historyEmpty: "Empty", kinhBtn: "KINH!", winMsg: "WINNER!", loseMsg: "Not yet!", walletLabel: "Wallet", quitConfirm: "Quit?", inviteBtn: "Invite", inviteTitle: "Invitation", copyBtn: "Copy", closeBtn: "Close", walletTitle: "Wallet", curLabel: "Currency", balLabel: "Balance", cancel: "Cancel", saveBtn: "Save", fullMsg: "Full" },
            th: { langName: "à¹„à¸—à¸¢", cur: "à¸¿", defWallet: 500, defBet: 20, welcomeMsg: "à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸š", playerNameLabel: "à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™", placeholderName: "à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­...", soloMode: "à¹€à¸¥à¹ˆà¸™à¸„à¸™à¹€à¸”à¸µà¸¢à¸§", multiMode: "à¹€à¸¥à¹ˆà¸™à¸«à¸¥à¸²à¸¢à¸„à¸™", setupTitle: "à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²", ticketCount: "à¸ˆà¸³à¸™à¸§à¸™à¹ƒà¸š", drawMethod: "à¸§à¸´à¸˜à¸µà¸ˆà¸±à¹ˆà¸§", speedLabel: "à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§", betAmount: "à¹€à¸”à¸´à¸¡à¸žà¸±à¸™", startBtn: "à¹€à¸£à¸´à¹ˆà¸¡", drawnLabel: "à¸ˆà¸±à¹ˆà¸§à¹à¸¥à¹‰à¸§", nextBtn: "à¸–à¸±à¸”à¹„à¸›", playText: "à¹€à¸¥à¹ˆà¸™", pauseText: "à¸«à¸¢à¸¸à¸”", homeBtn: "à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸", historyEmpty: "à¹„à¸¡à¹ˆà¸¡à¸µà¸›à¸£à¸°à¸§à¸±à¸•à¸´", kinhBtn: "à¸„à¸´à¸™!", winMsg: "à¸„à¸¸à¸“à¸Šà¸™à¸°!", loseMsg: "à¸¢à¸±à¸‡!", walletLabel: "à¸¢à¸­à¸”à¹€à¸‡à¸´à¸™", quitConfirm: "à¸­à¸­à¸?", inviteBtn: "à¹€à¸Šà¸´à¸", inviteTitle: "à¹€à¸Šà¸´à¸à¹€à¸žà¸·à¹ˆà¸­à¸™", copyBtn: "à¸„à¸±à¸”à¸¥à¸­à¸", closeBtn: "à¸›à¸´à¸”", walletTitle: "à¸à¸£à¸°à¹€à¸›à¹‹à¸²", curLabel: "à¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™", balLabel: "à¸¢à¸­à¸”", cancel: "à¸¢à¸à¹€à¸¥à¸´à¸", saveBtn: "à¸šà¸±à¸™à¸—à¸¶à¸", fullMsg: "à¹€à¸•à¹‡à¸¡" },
            lo: { langName: "àº¥àº²àº§", cur: "â‚­", defWallet: 500000, defBet: 10000, welcomeMsg: "àºàº´àº™àº”àºµàº•à»‰àº­àº™àº®àº±àºš", playerNameLabel: "àºŠàº·à»ˆàºœàº¹à»‰àº«àº¼àº´à»‰àº™", placeholderName: "à»ƒàºªà»ˆàºŠàº·à»ˆ...", soloMode: "àº«àº¼àº´à»‰àº™àº„àº»àº™àº”àº½àº§", multiMode: "àº«àº¼àº´à»‰àº™àº«àº¼àº²àºàº„àº»àº™", setupTitle: "àº•àº±à»‰àº‡àº„à»ˆàº²", ticketCount: "à»ƒàºš", drawMethod: "àº§àº´àº—àºµ", speedLabel: "àº„àº§àº²àº¡à»„àº§", betAmount: "à»€àº”àºµàº¡àºžàº±àº™", startBtn: "à»€àº¥àºµà»ˆàº¡", drawnLabel: "àº­àº­àºà»àº¥à»‰àº§", nextBtn: "àº•à»à»ˆà»„àº›", playText: "àº«àº¼àº´à»‰àº™", pauseText: "àº¢àº¸àº”", homeBtn: "à»œà»‰àº²àº«àº¼àº±àº", historyEmpty: "àºšà»à»ˆàº¡àºµàº›àº°àº«àº§àº±àº”", kinhBtn: "àºàº´àº™!", winMsg: "àºŠàº°àº™àº°!", loseMsg: "àºàº±àº‡!", walletLabel: "àºàº­àº”", quitConfirm: "àº­àº­àº?", inviteBtn: "à»€àºŠàºµàº™", inviteTitle: "à»€àºŠàºµàº™", copyBtn: "àº„àº±àº”àº¥àº­àº", closeBtn: "àº›àº´àº”", walletTitle: "àºàº°à»€àº›àº»àº²", curLabel: "àºªàº°àºàº¸àº™", balLabel: "àºàº­àº”", cancel: "àºàº»áž€à»€àº¥àºµàº", saveBtn: "àºšàº±àº™àº—àº¶àº", fullMsg: "à»€àº•àº±àº¡" },
            km: { langName: "ážáŸ’áž˜áŸ‚ážš", cur: "áŸ›", defWallet: 80000, defBet: 2000, welcomeMsg: "ážŸáž¼áž˜ážŸáŸ’ážœáž¶áž‚áž˜áž“áŸ", playerNameLabel: "ážˆáŸ’áž˜áŸ„áŸ‡áž¢áŸ’áž“áž€áž›áŸáž„", placeholderName: "áž”áž‰áŸ’áž…áž¼áž›ážˆáŸ’áž˜áŸ„áŸ‡...", soloMode: "áž˜áŸ’áž“áž¶áž€áŸ‹áž¯áž„", multiMode: "áž…áŸ’ážšáž¾áž“áž“áž¶áž€áŸ‹", setupTitle: "áž€áž¶ážšáž€áŸ†ážŽážáŸ‹", ticketCount: "ážŸáž“áŸ’áž›áž¹áž€", drawMethod: "ážœáž·áž’áž¸", speedLabel: "áž›áŸ’áž”áž¿áž“", betAmount: "áž—áŸ’áž“áž¶áž›áŸ‹", startBtn: "áž•áŸ’ážŠáž¾áž˜", drawnLabel: "áž…áŸáž‰áž áž¾áž™", nextBtn: "áž”áž“áŸ’áž‘áž¶áž”áŸ‹", playText: "áž”áž“áŸ’áž", pauseText: "ážˆáž”áŸ‹", homeBtn: "áž˜áŸ", historyEmpty: "áž‚áŸ’áž˜áž¶áž“áž”áŸ’ážšážœážáŸ’ážáž·", kinhBtn: "áž‚áž¸áž“!", winMsg: "ážˆáŸ’áž“áŸ‡!", loseMsg: "áž“áŸ…!", walletLabel: "ážŸáž˜ážáž»áž›áŸ’áž™", quitConfirm: "áž…áŸáž‰?", inviteBtn: "áž¢áž‰áŸ’áž‡áž¾áž‰", inviteTitle: "áž¢áž‰áŸ’áž‡áž¾áž‰", copyBtn: "áž…áž˜áŸ’áž›áž„", closeBtn: "áž”áž·áž‘", walletTitle: "áž€áž¶áž”áž¼áž”", curLabel: "ážšáž¼áž”áž·áž™", balLabel: "ážŸáž˜ážáž»áž›áŸ’áž™", cancel: "áž”áŸ„áŸ‡áž”áž„áŸ‹", saveBtn: "ážšáž€áŸ’ážŸáž¶", fullMsg: "áž–áŸáž‰" },
            zh: { langName: "ç®€ä½“ä¸­æ–‡", cur: "Â¥", defWallet: 150, defBet: 5, welcomeMsg: "æ¬¢è¿Ž", playerNameLabel: "å§“å", placeholderName: "è¾“å…¥...", soloMode: "å•äºº", multiMode: "å¤šäºº", setupTitle: "è®¾ç½®", ticketCount: "ç¥¨æ•°", drawMethod: "æ–¹å¼", speedLabel: "é€Ÿåº¦", betAmount: "ä¸‹æ³¨", startBtn: "å¼€å§‹", drawnLabel: "å·²æŠ½", nextBtn: "ä¸‹ä¸ª", playText: "ç»§ç»­", pauseText: "æš‚åœ", homeBtn: "é¦–é¡µ", historyEmpty: "æš‚æ— æ•°æ®", kinhBtn: "èµ¢äº†!", winMsg: "æ­å–œ!", loseMsg: "æœªä¸­!", walletLabel: "ä½™é¢", quitConfirm: "é€€å‡º?", inviteBtn: "é‚€è¯·", inviteTitle: "é‚€è¯·å¥½å‹", copyBtn: "å¤åˆ¶", closeBtn: "å…³é—­", walletTitle: "é’±åŒ…", curLabel: "è´§å¸", balLabel: "ä½™é¢", cancel: "å–æ¶ˆ", saveBtn: "ä¿å­˜", fullMsg: "æ»¡å‘˜" },
            fr: { langName: "FranÃ§ais", cur: "â‚¬", defWallet: 20, defBet: 1, welcomeMsg: "Bienvenue", playerNameLabel: "Nom", placeholderName: "Nom...", soloMode: "Solo", multiMode: "Multi", setupTitle: "RÃ©glage", ticketCount: "Tickets", drawMethod: "Mode", speedLabel: "Vitesse", betAmount: "Mise", startBtn: "JOUER", drawnLabel: "TirÃ©s", nextBtn: "Suiv.", playText: "Play", pauseText: "Pause", homeBtn: "Home", historyEmpty: "Vide", kinhBtn: "KINH!", winMsg: "GagnÃ©!", loseMsg: "Non!", walletLabel: "Solde", quitConfirm: "Quitter?", inviteBtn: "Inviter", inviteTitle: "Invitation", copyBtn: "Copier", closeBtn: "Fermer", walletTitle: "Porte-monnaie", curLabel: "Devise", balLabel: "Solde", cancel: "Annuler", saveBtn: "Sauver", fullMsg: "Plein" }
        };

        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;
        createApp({
            setup() {
                const currentLang = ref(localStorage.getItem('loto_lang') || 'ja');
                const t = computed(() => i18n[currentLang.value] || i18n.ja);
                const gameState = ref('HOME');
                const mode = ref('SOLO');
                const playerName = ref(localStorage.getItem('loto_player_name') || '');
                const wallet = reactive({ amount: 3000, currency: 'Â¥' });
                const tempWallet = reactive({ amount: 0, currency: '' });
                const showWalletModal = ref(false);
                const showShareModal = ref(false);
                const ticketCount = ref(1);
                const betAmount = ref(100);
                const isAuto = ref(true);
                const drawInterval = ref(4);
                const isPaused = ref(false);
                const myCards = ref([]);
                const myMarks = ref([]);
                const currentNumber = ref(null);
                const drawnHistory = ref([]);
                const roomId = ref(new URLSearchParams(window.location.search).get('room'));
                const logs = ref([]);
                const lastLogTime = ref(Date.now());
                const isMaster = ref(false);
                let timer = null;

                const addLog = (m) => { const id = Date.now(); logs.value.push({id, message: m}); setTimeout(() => logs.value = logs.value.filter(l => l.id !== id), 3000); };
                
                const handleLangChange = () => { 
                    localStorage.setItem('loto_lang', currentLang.value);
                    const config = t.value;
                    wallet.currency = config.cur;
                    wallet.amount = config.defWallet;
                    betAmount.value = config.defBet;
                };

                const initGame = async (m) => {
                    mode.value = m;
                    const safeName = playerName.value.trim().replace(/[.#$[\]]/g, "_") || 'Player_' + Math.floor(Math.random()*900+100);
                    playerName.value = safeName; localStorage.setItem('loto_player_name', safeName);
                    if(m === 'MULTI') {
                        if(!roomId.value) { roomId.value = Math.random().toString(36).substring(2, 7).toUpperCase(); isMaster.value = true; }
                        const url = new URL(window.location.href); url.searchParams.set('room', roomId.value); window.history.pushState({}, '', url);
                        const roomRef = db.ref(`rooms/${roomId.value}`);
                        const pRef = roomRef.child('players');
                        const s = await pRef.once('value');
                        if(!isMaster.value && !s.exists()) isMaster.value = true;
                        if(Object.keys(s.val()||{}).length >= 10 && !(s.val()||{})[safeName]) return alert(t.value.fullMsg);
                        pRef.child(safeName).set(true);
                        roomRef.update({ msg: `${safeName} joined!`, msgTime: firebase.database.ServerValue.TIMESTAMP });
                    }
                    gameState.value = 'SETUP';
                };

                const stopAllProcesses = () => { if(timer) { clearInterval(timer); timer = null; } if(mode.value === 'MULTI' && roomId.value) { db.ref(`rooms/${roomId.value}`).off(); } isPaused.value = false; };
                
                const startGame = () => {
                    if(wallet.amount < (betAmount.value * ticketCount.value)) return alert("Low balance");
                    wallet.amount -= (betAmount.value * ticketCount.value);
                    myCards.value = Array.from({length: ticketCount.value}, () => generateCard());
                    myMarks.value = myCards.value.map(c => c.map(r => r.map(() => false)));
                    drawnHistory.value = []; currentNumber.value = null; 
                    gameState.value = 'PLAYING';
                    if(mode.value === 'MULTI') {
                        const rRef = db.ref(`rooms/${roomId.value}`); lastLogTime.value = Date.now();
                        rRef.on('value', s => { const d = s.val(); if(d){ if(d.num) currentNumber.value = d.num; if(d.his) drawnHistory.value = d.his || []; if(d.msg && d.msgTime && d.msgTime > lastLogTime.value){ addLog(d.msg); lastLogTime.value = d.msgTime; } } });
                    }
                    if(isAuto.value && (mode.value === 'SOLO' || isMaster.value)) { startTimer(); }
                };

                const startTimer = () => { if(timer) clearInterval(timer); timer = setInterval(() => { if(!isPaused.value && drawnHistory.value.length < 90) { drawNext(); } }, drawInterval.value * 1000); };
                
                const drawNext = () => {
                    if(drawnHistory.value.length >= 90) { stopAllProcesses(); return; }
                    let n; do { n = Math.floor(Math.random()*90)+1; } while(drawnHistory.value.includes(n));
                    if(mode.value === 'SOLO') { currentNumber.value = n; drawnHistory.value.push(n); } 
                    else if(isMaster.value) { db.ref(`rooms/${roomId.value}`).update({ num: n, his: [...drawnHistory.value, n] }); }
                };

                const checkKinh = () => {
                    const win = myMarks.value.some((card, cIdx) => card.some((row, rIdx) => {
                        const nums = myCards.value[cIdx][rIdx].filter(n => n !== 0);
                        const marks = myCards.value[cIdx][rIdx].filter((n, nIdx) => n !== 0 && row[nIdx]);
                        return nums.length === 5 && marks.length === 5 && marks.every(n => drawnHistory.value.includes(n));
                    }));
                    if(win) { 
                        alert(t.value.winMsg); wallet.amount += (betAmount.value * 10); 
                        if(mode.value === 'MULTI') { db.ref(`rooms/${roomId.value}`).update({ msg: `ðŸŽ‰ ${playerName.value} KINH!`, msgTime: firebase.database.ServerValue.TIMESTAMP }); }
                        exitToHome(); 
                    } else alert(t.value.loseMsg);
                };

                const exitToHome = async () => {
                    stopAllProcesses();
                    if(mode.value === 'MULTI' && roomId.value) {
                        const pRef = db.ref(`rooms/${roomId.value}/players/${playerName.value}`);
                        await pRef.remove();
                        const s = await db.ref(`rooms/${roomId.value}/players`).once('value');
                        if(!s.exists()) await db.ref(`rooms/${roomId.value}`).remove();
                    }
                    gameState.value = 'HOME';
                };

                const togglePause = () => { isPaused.value = !isPaused.value; };
                const confirmQuit = () => { if(confirm(t.value.quitConfirm)) { exitToHome(); } };
                const toggleMark = (cIdx, rIdx, nIdx) => { if (myCards.value[cIdx][rIdx][nIdx] !== 0) myMarks.value[cIdx][rIdx][nIdx] = !myMarks.value[cIdx][rIdx][nIdx]; };
                const isMarked = (cIdx, rIdx, nIdx) => myMarks.value[cIdx]?.[rIdx]?.[nIdx];
                
                const generateCard = () => {
                    let card = [Array(9).fill(0), Array(9).fill(0), Array(9).fill(0)];
                    const colBounds = [[1,9],[10,19],[20,29],[30,39],[40,49],[50,59],[60,69],[70,79],[80,90]];
                    for(let r=0; r<3; r++){
                        let cols = [0,1,2,3,4,5,6,7,8].sort(()=>Math.random()-0.5).slice(0,5).sort();
                        cols.forEach(c => {
                            let [min, max] = colBounds[c];
                            let n; do { n = Math.floor(Math.random() * (max - min + 1)) + min; } while(card[0][c]===n || card[1][c]===n || card[2][c]===n);
                            card[r][c] = n;
                        });
                    }
                    return card;
                };

                const openWalletModal = () => { tempWallet.amount = wallet.amount; tempWallet.currency = wallet.currency; showWalletModal.value = true; };
                const saveWallet = () => { wallet.amount = tempWallet.amount; wallet.currency = tempWallet.currency; showWalletModal.value = false; };
                const copyLink = () => { navigator.clipboard.writeText(window.location.href); addLog(t.value.copyBtn + " OK!"); };

                watch(showShareModal, (v) => { if(v) setTimeout(() => { const qrEl = document.getElementById('qrcode'); qrEl.innerHTML = ""; new QRCode(qrEl, { text: window.location.href, width: 200, height: 200 }); }, 100); });
                onMounted(() => { if(roomId.value) initGame('MULTI'); handleLangChange(); });

                return { currentLang, t, i18n, gameState, mode, playerName, wallet, tempWallet, showWalletModal, showShareModal, ticketCount, betAmount, isAuto, drawInterval, isPaused, myCards, currentNumber, drawnHistory, roomId, logs, handleLangChange, initGame, startGame, drawNext, checkKinh, confirmQuit, toggleMark, isMarked, openWalletModal, saveWallet, copyLink, togglePause };
            }
        }).mount('#app');
    </script>
</body>
</html>
