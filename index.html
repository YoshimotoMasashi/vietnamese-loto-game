<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lô Tô Master - Multiple Cards</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; }
        .cell { transition: all 0.2s; aspect-ratio: 1/1; user-select: none; }
        .marked { background-color: #ef4444; color: white; border-color: #ef4444; transform: scale(0.95); box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .ticket { transition: transform 0.2s; }
        .ticket:active { transform: scale(0.99); }
        /* スクロールバー非表示（スマホ用） */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        [v-cloak] { display: none; }
        .modal-enter-active, .modal-leave-active { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
    </style>
</head>
<body>
    <div id="app" v-cloak class="min-h-screen max-w-md mx-auto flex flex-col relative bg-slate-100 shadow-2xl overflow-hidden">
        
        <div class="fixed top-4 left-0 right-0 z-50 pointer-events-none px-4 space-y-2">
            <div v-for="log in logs" :key="log.id" class="bg-gray-800 text-white text-xs py-2 px-3 rounded shadow-lg opacity-90 animate-fade-in-down mx-auto max-w-xs text-center">
                {{ log.message }}
            </div>
        </div>

        <header class="bg-white p-3 shadow-md z-10 flex justify-between items-center sticky top-0">
            <div class="flex items-center space-x-2">
                <span class="font-black text-red-600 text-xl italic tracking-tighter">LÔ TÔ</span>
                <span v-if="mode === 'MULTI'" class="bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded-full font-bold">ONLINE</span>
                <span v-else class="bg-gray-100 text-gray-800 text-[10px] px-2 py-0.5 rounded-full font-bold">SOLO</span>
            </div>

            <button @click="openWalletModal" class="flex flex-col items-end group active:scale-95 transition">
                <span class="text-[10px] text-gray-400 font-bold group-hover:text-red-500">WALLET <i class="fas fa-pen ml-1"></i></span>
                <span class="font-bold text-lg text-green-600 leading-none">
                    {{ wallet.currency }} {{ wallet.amount.toLocaleString() }}
                </span>
            </button>
        </header>

        <div v-if="gameState === 'SELECT_MODE'" class="flex-grow flex flex-col justify-center p-6 space-y-6 bg-white">
            <div class="text-center space-y-2">
                <i class="fas fa-dice text-6xl text-red-500 mb-4 animate-bounce"></i>
                <h1 class="text-2xl font-bold text-slate-800">ロートーへようこそ</h1>
                <p class="text-sm text-gray-500">遊び方を選んでください</p>
            </div>

            <button @click="setupGame('SOLO')" class="w-full bg-slate-100 hover:bg-slate-200 border-2 border-slate-300 p-6 rounded-xl flex items-center space-x-4 transition group">
                <div class="bg-white p-3 rounded-full shadow-sm group-hover:scale-110 transition"><i class="fas fa-user text-slate-600"></i></div>
                <div class="text-left">
                    <p class="font-bold text-slate-800">ひとりで練習</p>
                    <p class="text-xs text-slate-500">CPUと対戦・ルール確認</p>
                </div>
            </button>

            <button @click="setupGame('MULTI')" class="w-full bg-red-50 hover:bg-red-100 border-2 border-red-200 p-6 rounded-xl flex items-center space-x-4 transition group">
                <div class="bg-white p-3 rounded-full shadow-sm group-hover:scale-110 transition"><i class="fas fa-users text-red-600"></i></div>
                <div class="text-left">
                    <p class="font-bold text-red-800">みんなで対戦</p>
                    <p class="text-xs text-red-600">URLをシェアして同期プレイ</p>
                </div>
            </button>
        </div>

        <div v-else-if="gameState === 'SETUP'" class="flex-grow p-6 bg-white flex flex-col">
            <h2 class="text-xl font-bold mb-6 text-center">準備画面</h2>
            
            <div class="mb-8">
                <label class="block text-sm font-bold text-gray-700 mb-2">チケット枚数 (セット)</label>
                <div class="grid grid-cols-4 gap-2">
                    <button v-for="n in 4" :key="n" @click="ticketCount = n"
                        :class="ticketCount === n ? 'bg-red-600 text-white border-red-600' : 'bg-white text-gray-600 border-gray-300'"
                        class="py-3 rounded-lg border-2 font-bold transition">
                        {{ n }}
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">※枚数が多いほど確率は上がりますが、管理が大変です！</p>
            </div>

            <div class="mb-auto">
                <label class="block text-sm font-bold text-gray-700 mb-1">参加費 (Bet)</label>
                <div class="flex items-center border-2 border-gray-200 rounded-lg bg-gray-50 px-3">
                    <span class="text-gray-500 font-bold mr-2">{{ wallet.currency }}</span>
                    <input type="number" v-model.number="betAmount" class="w-full py-3 bg-transparent text-xl font-bold outline-none">
                </div>
            </div>

            <div class="space-y-3 mt-4">
                <button @click="startGame" class="w-full bg-red-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:transform active:scale-95 transition">
                    ゲーム開始
                </button>
                <button @click="gameState = 'SELECT_MODE'" class="w-full text-gray-400 text-sm">戻る</button>
            </div>
        </div>

        <div v-else-if="gameState === 'PLAYING' || gameState === 'FINISHED'" class="flex-grow flex flex-col h-full overflow-hidden">
            
            <div class="bg-white p-2 border-b flex items-center justify-between shadow-sm z-10">
                <div class="flex items-center space-x-3">
                    <div class="w-14 h-14 bg-red-600 rounded-full flex items-center justify-center text-white text-2xl font-bold shadow-inner border-2 border-red-400">
                        {{ currentNumber || '?' }}
                    </div>
                    <div>
                        <p class="text-[10px] text-gray-400 uppercase tracking-wide">Last Number</p>
                        <div class="flex space-x-1 overflow-hidden w-32 h-6 items-center">
                            <span v-for="n in drawnHistory.slice().reverse().slice(0,5)" :key="n" class="text-xs bg-gray-100 px-1 rounded text-gray-600">{{n}}</span>
                        </div>
                    </div>
                </div>
                <button v-if="mode === 'MULTI'" @click="copyLink" class="bg-blue-50 text-blue-600 px-3 py-1 rounded text-xs font-bold border border-blue-100">
                    <i class="fas fa-link mr-1"></i>Invite
                </button>
            </div>

            <div class="flex-grow overflow-y-auto p-4 space-y-4 no-scrollbar bg-slate-100 pb-24">
                <div v-for="(card, cardIndex) in myCards" :key="cardIndex" class="ticket bg-white p-1.5 rounded-lg shadow-md border border-gray-200">
                    <div class="flex justify-between items-center px-1 mb-1">
                        <span class="text-[10px] text-gray-400 font-bold">TICKET #{{ cardIndex + 1 }}</span>
                        <span v-if="cardStatus[cardIndex]" class="text-xs font-bold text-red-500 animate-pulse">KINH! (WIN)</span>
                    </div>
                    <div v-for="(row, rIndex) in card" :key="rIndex" 
                         class="grid grid-cols-9 gap-0.5 mb-0.5 p-0.5 rounded transition"
                         :class="{'bg-yellow-100 ring-2 ring-yellow-400': isRowComplete(row)}">
                        <div v-for="(num, cIndex) in row" :key="cIndex" 
                             class="cell flex items-center justify-center text-xs sm:text-sm font-bold border rounded-sm h-8 sm:h-9"
                             :class="getCellClass(num)"
                             @click="toggleMark(num)">
                            {{ num !== 0 ? num : '' }}
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 p-4 bg-white rounded-lg">
                    <p class="text-xs text-gray-400 mb-2 font-bold">DRAWN HISTORY</p>
                    <div class="flex flex-wrap gap-1">
                        <span v-for="n in drawnHistory.sort((a,b)=>a-b)" :key="n" class="w-6 h-6 flex items-center justify-center bg-gray-200 text-[10px] rounded-full text-gray-600 font-bold">
                            {{ n }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur border-t shadow-lg flex space-x-3">
                <button @click="checkKinh" class="flex-1 bg-yellow-400 text-yellow-900 py-3 rounded-xl font-black text-xl shadow-lg border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1 transition">
                    KINH! (あがり)
                </button>
                <button v-if="gameState === 'FINISHED'" @click="resetGame" class="bg-gray-800 text-white px-6 rounded-xl font-bold">
                    再戦
                </button>
            </div>
        </div>

        <transition name="modal">
            <div v-if="showWalletModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all">
                    <h3 class="text-lg font-bold mb-4 flex items-center"><i class="fas fa-wallet mr-2 text-green-600"></i>所持金設定</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">通貨単位</label>
                            <select v-model="tempWallet.currency" class="w-full bg-gray-100 border rounded p-2 text-sm">
                                <option value="$">Dollar ($)</option>
                                <option value="¥">Yen (¥)</option>
                                <option value="₫">Dong (₫)</option>
                                <option value="€">Euro (€)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">金額</label>
                            <input type="number" v-model.number="tempWallet.amount" class="w-full bg-gray-100 border rounded p-3 text-xl font-bold">
                        </div>
                    </div>

                    <div class="mt-6 flex space-x-3">
                        <button @click="showWalletModal = false" class="flex-1 py-2 text-gray-500 font-bold">キャンセル</button>
                        <button @click="confirmWalletUpdate" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold shadow-md">
                            変更を保存
                        </button>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        // --- 1. Firebase設定 (自分のプロジェクト情報を入力してください) ---
        const firebaseConfig = {
            apiKey: "API_KEY_HERE",
            authDomain: "PROJECT.firebaseapp.com",
            databaseURL: "https://PROJECT.firebaseio.com",
            projectId: "PROJECT_ID",
            storageBucket: "PROJECT.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        // 初期化エラー回避
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const { createApp, ref, computed, onMounted, reactive } = Vue;

        createApp({
            setup() {
                // --- 状態管理 ---
                const mode = ref('SOLO'); // SOLO or MULTI
                const gameState = ref('SELECT_MODE'); // SELECT_MODE, SETUP, PLAYING, FINISHED
                const roomId = ref(new URLSearchParams(window.location.search).get('room'));
                
                // ウォレット
                const wallet = reactive({ amount: 10000, currency: '¥' });
                const showWalletModal = ref(false);
                const tempWallet = reactive({ ...wallet });

                // ゲーム設定
                const ticketCount = ref(1); // 1~4枚
                const betAmount = ref(100);
                
                // ゲームデータ
                const currentNumber = ref(null);
                const drawnHistory = ref([]);
                const myCards = ref([]); // 配列の配列（複数枚）
                const cardStatus = ref([]); // 各カードの勝利状態
                const logs = ref([]); // 通知ログ

                // --- 1. ゲーム準備・カード生成 ---
                const setupGame = (selectedMode) => {
                    mode.value = selectedMode;
                    if (selectedMode === 'MULTI' && !roomId.value) {
                        // ルームID生成とURL書き換え
                        const newId = Math.random().toString(36).substring(2, 6).toUpperCase();
                        const url = new URL(window.location);
                        url.searchParams.set('room', newId);
                        window.history.pushState({}, '', url);
                        roomId.value = newId;
                    }
                    gameState.value = 'SETUP';
                };

                const generateOneTicket = () => {
                    // 3行9列のカード生成（ベトナム式：各行5数字、列範囲固定）
                    let card = [Array(9).fill(0), Array(9).fill(0), Array(9).fill(0)];
                    // 列ごとの範囲定義 (0:1-9, 1:10-19...)
                    const colRanges = [
                        [1,9], [10,19], [20,29], [30,39], [40,49], 
                        [50,59], [60,69], [70,79], [80,90]
                    ];

                    for(let r=0; r<3; r++) {
                        // 各行にランダムに5つの列を選ぶ
                        let cols = [0,1,2,3,4,5,6,7,8].sort(()=>Math.random()-0.5).slice(0,5).sort((a,b)=>a-b);
                        cols.forEach(c => {
                            const [min, max] = colRanges[c];
                            let num;
                            // 重複チェック簡易版
                            do {
                                num = Math.floor(Math.random() * (max - min + 1)) + min;
                            } while(card[0][c] === num || card[1][c] === num); // 縦の重複回避
                            card[r][c] = num;
                        });
                        // 縦列のソート（本来のルールでは縦も整列する）
                    }
                    return card;
                };

                const startGame = () => {
                    if (wallet.amount < betAmount.value) {
                        alert("所持金が足りません！");
                        return;
                    }
                    
                    // カード生成
                    myCards.value = [];
                    cardStatus.value = [];
                    for(let i=0; i<ticketCount.value; i++) {
                        myCards.value.push(generateOneTicket());
                        cardStatus.value.push(false);
                    }

                    // ゲーム開始処理
                    wallet.amount -= betAmount.value;
                    gameState.value = 'PLAYING';
                    currentNumber.value = null;
                    drawnHistory.value = [];

                    if (mode.value === 'SOLO') {
                        startSoloLoop();
                    } else {
                        connectMultiplayer();
                    }
                };

                // --- 2. ソロプレイのループ ---
                let soloTimer = null;
                const startSoloLoop = () => {
                    if (soloTimer) clearInterval(soloTimer);
                    soloTimer = setInterval(() => {
                        if (gameState.value !== 'PLAYING') {
                            clearInterval(soloTimer);
                            return;
                        }
                        if (drawnHistory.value.length >= 90) return;

                        // 抽選
                        let next;
                        do { next = Math.floor(Math.random() * 90) + 1; } while(drawnHistory.value.includes(next));
                        
                        currentNumber.value = next;
                        drawnHistory.value.push(next);
                        
                    }, 2500); // 2.5秒間隔
                };

                // --- 3. マルチプレイ同期 ---
                const connectMultiplayer = () => {
                    if(!roomId.value) return;
                    const roomRef = db.ref(`rooms/${roomId.value}`);
                    const logRef = db.ref(`rooms/${roomId.value}/logs`);

                    // ログ監視
                    logRef.on('child_added', (snap) => {
                        addLog(snap.val().message);
                    });

                    // ホストなら抽選ロジック（簡易：今回は全員がリスナーになるため、ホスト機能は省略し、共通DBを参照）
                    // ※本来はホストのみが書き込むべきだが、簡易化のため割愛
                    // ここでは「読み取り専用」として実装し、ホスト（最初に部屋を作った人）が書き込む等の制御が必要
                    
                    roomRef.on('value', (snap) => {
                        const val = snap.val();
                        if(val) {
                            if(val.currentNumber) currentNumber.value = val.currentNumber;
                            if(val.history) drawnHistory.value = val.history;
                            if(val.status === 'FINISHED') gameState.value = 'FINISHED';
                        }
                    });
                };

                // --- 4. ウォレット編集と通知 ---
                const openWalletModal = () => {
                    tempWallet.amount = wallet.amount;
                    tempWallet.currency = wallet.currency;
                    showWalletModal.value = true;
                };

                const confirmWalletUpdate = () => {
                    const oldAmount = wallet.amount;
                    const newAmount = tempWallet.amount;

                    if (gameState.value === 'PLAYING') {
                        const confirmed = confirm(
                            `ゲーム進行中です！\n本当に所持金を変更しますか？\n\n${wallet.currency}${oldAmount} → ${tempWallet.currency}${newAmount}`
                        );
                        if (!confirmed) return;
                    }

                    // 更新
                    wallet.amount = newAmount;
                    wallet.currency = tempWallet.currency;
                    showWalletModal.value = false;

                    // 通知送信 (マルチのみ)
                    if (mode.value === 'MULTI' && roomId.value) {
                        const msg = `あるプレイヤーが所持金を ${oldAmount} から ${newAmount} に変更しました`;
                        db.ref(`rooms/${roomId.value}/logs`).push({
                            message: msg,
                            timestamp: Date.now()
                        });
                    } else {
                        addLog(`所持金を変更しました: ${newAmount}`);
                    }
                };

                // --- 5. 判定ロジック ---
                const getCellClass = (num) => {
                    if(num === 0) return 'bg-slate-50 border-transparent';
                    if(drawnHistory.value.includes(num)) return 'marked font-bold';
                    return 'bg-white text-gray-800 border-gray-200';
                };

                const toggleMark = (num) => {
                    // 自動判定なので手動マークは視覚効果のみ、あるいは自動で十分なら何もしない
                    // 今回は自動判定のため実装なし
                };

                const isRowComplete = (row) => {
                    const nums = row.filter(n => n !== 0);
                    return nums.length > 0 && nums.every(n => drawnHistory.value.includes(n));
                };

                const checkKinh = () => {
                    let winFound = false;
                    myCards.value.forEach((card, idx) => {
                        const hasRowWin = card.some(row => isRowComplete(row));
                        if(hasRowWin) {
                            cardStatus.value[idx] = true;
                            winFound = true;
                        }
                    });

                    if(winFound) {
                        gameState.value = 'FINISHED';
                        if(soloTimer) clearInterval(soloTimer);
                        wallet.amount += betAmount.value * 4 * ticketCount.value; // 簡易配当
                        addLog("おめでとうございます！KINHです！");
                        if(mode.value === 'MULTI') {
                            db.ref(`rooms/${roomId.value}`).update({ status: 'FINISHED' });
                        }
                        alert("KINH! おめでとうございます！");
                    } else {
                        alert("まだ揃っていません (Chưa Kinh!)");
                    }
                };

                // ユーティリティ
                const addLog = (msg) => {
                    const id = Date.now();
                    logs.value.push({ id, message: msg });
                    setTimeout(() => {
                        logs.value = logs.value.filter(l => l.id !== id);
                    }, 4000);
                };

                const copyLink = () => {
                    navigator.clipboard.writeText(window.location.href);
                    addLog("URLをコピーしました");
                };

                const resetGame = () => {
                    gameState.value = 'SETUP';
                    // モードは維持
                };

                // URLパラメータチェック（招待された場合）
                onMounted(() => {
                    if(roomId.value) {
                        setupGame('MULTI');
                    }
                });

                return {
                    mode, gameState, wallet, showWalletModal, tempWallet, ticketCount, betAmount,
                    currentNumber, drawnHistory, myCards, cardStatus, logs,
                    setupGame, startGame, openWalletModal, confirmWalletUpdate,
                    getCellClass, toggleMark, isRowComplete, checkKinh, copyLink, resetGame
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
