<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lô Tô Global - Full Specification Rev 12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        [v-cloak] { display: none; }
        .cell { aspect-ratio: 1/1; font-weight: 800; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0; font-size: 0.9rem; background: white; transition: all 0.2s; position: relative; cursor: pointer; }
        .marked::after { content: ''; position: absolute; width: 75%; height: 75%; background-color: rgba(239, 68, 68, 0.85); border-radius: 50%; z-index: 10; animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cell-num { z-index: 20; }
        .marked .cell-num { color: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .history-item { width: 36px; height: 36px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #334155; font-weight: 800; font-size: 0.85rem; color: #cbd5e1; border: 1px solid #475569; transition: all 0.3s; }
        .history-latest { background: #ef4444; color: white; border-color: #ef4444; transform: scale(1.1); box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); z-index: 10; }
        
        .history-match { background: #fbbf24 !important; color: #78350f !important; border-color: #f59e0b !important; animation: match-glow 1s infinite alternate; transform: scale(1.15); z-index: 11; }
        @keyframes match-glow { from { box-shadow: 0 0 5px #fbbf24; } to { box-shadow: 0 0 20px #fbbf24; } }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    <div id="app" v-cloak class="min-h-screen max-w-md mx-auto flex flex-col bg-white shadow-2xl relative overflow-hidden text-slate-800">
        
        <header class="p-3 bg-white border-b flex justify-between items-center sticky top-0 z-40 h-20 shadow-sm">
            <button v-if="gameState !== 'HOME'" @click="confirmQuit" class="flex flex-col items-center justify-center min-w-[60px] text-slate-500 hover:text-red-500 transition">
                <i class="fas fa-home text-xl"></i>
                <span class="text-[10px] font-black uppercase mt-1">{{ t.homeBtn }}</span>
            </button>
            <div v-else class="w-10"></div>
            
            <select v-model="currentLang" @change="handleLangChange" class="text-sm font-black bg-slate-50 border-2 rounded-xl px-2 py-2 outline-none border-slate-200">
                <option v-for="(l, code) in i18n" :key="code" :value="code">{{ l.langName }}</option>
            </select>

            <button @click="openWalletModal" class="flex items-center bg-green-50 px-4 py-2 rounded-2xl border-2 border-green-100 active:scale-95 transition">
                <div class="flex flex-col items-end mr-3">
                    <span class="text-[10px] text-green-700 font-black leading-none uppercase tracking-widest">{{ t.walletLabel }}</span>
                    <span class="font-black text-green-600 text-2xl leading-tight">{{ wallet.currency }}{{ wallet.amount.toLocaleString() }}</span>
                </div>
                <i class="fas fa-wallet text-green-400 text-lg"></i>
            </button>
        </header>

        <main class="flex-grow flex flex-col overflow-hidden relative">
            
            <div v-if="gameState === 'HOME'" class="flex-grow p-8 flex flex-col justify-center space-y-8">
                <div class="text-center">
                    <h1 class="text-7xl font-black text-red-600 italic tracking-tighter drop-shadow-md">LÔ TÔ</h1>
                    <p class="text-xs text-slate-400 font-black tracking-[0.5em] uppercase mt-2">{{ t.welcomeMsg }}</p>
                </div>
                <div class="bg-slate-50 p-5 rounded-[2.5rem] border-4 border-slate-100 shadow-inner">
                    <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest ml-3 block mb-1">{{ t.playerNameLabel }}</label>
                    <input type="text" v-model="playerName" class="w-full bg-transparent text-2xl font-black px-3 outline-none text-slate-700" :placeholder="t.placeholderName">
                </div>
                <div class="space-y-4">
                    <button @click="initGame('SOLO')" class="w-full bg-slate-900 text-white p-6 rounded-[2rem] flex items-center shadow-2xl active:scale-95 transition font-black text-xl uppercase italic">
                        <i class="fas fa-play text-3xl mr-6"></i>
                        <span>{{ t.soloMode }}</span>
                    </button>
                    <button @click="initGame('MULTI')" class="w-full bg-red-600 text-white p-6 rounded-[2rem] flex items-center shadow-2xl active:scale-95 transition font-black text-xl uppercase italic">
                        <i class="fas fa-users text-3xl mr-6"></i>
                        <span>{{ t.multiMode }}</span>
                    </button>
                </div>
            </div>

            <div v-else-if="gameState === 'SETUP'" class="flex-grow p-8 space-y-6 overflow-y-auto no-scrollbar">
                <h2 class="text-center font-black text-3xl text-slate-800 italic uppercase border-b-4 border-red-500 inline-block mx-auto pb-1 mb-6 w-full">{{ t.setupTitle }}</h2>
                
                <div class="space-y-3">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">{{ t.ticketCount }}</label>
                    <div class="grid grid-cols-4 gap-3">
                        <button v-for="n in 4" :key="n" @click="ticketCount = n" :class="ticketCount === n ? 'bg-red-600 text-white scale-105 shadow-xl' : 'bg-slate-100 text-slate-400'" class="py-4 rounded-2xl font-black text-xl transition">{{ n }}</button>
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">{{ t.drawMethod }}</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="isAuto = true" :class="isAuto ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-100 text-slate-400'" class="py-5 rounded-2xl font-black text-lg transition uppercase">Auto</button>
                        <button @click="isAuto = false" :class="!isAuto ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-100 text-slate-400'" class="py-5 rounded-2xl font-black text-lg transition uppercase">Manual</button>
                    </div>
                </div>

                <div v-if="isAuto" class="space-y-3 bg-slate-50 p-5 rounded-3xl shadow-inner">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-black text-slate-400 uppercase">{{ t.speedLabel }}</label>
                        <span class="text-xl font-black text-red-600">{{ drawInterval }}s</span>
                    </div>
                    <input type="range" v-model="drawInterval" min="2" max="10" step="1" class="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-600">
                </div>

                <div class="space-y-3">
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest">{{ t.betAmount }}</label>
                    <div class="flex items-center bg-slate-50 p-5 rounded-3xl border-4 border-slate-100 shadow-inner">
                        <span class="font-black text-slate-400 text-2xl mr-4">{{ wallet.currency }}</span>
                        <input type="number" v-model.number="betAmount" class="bg-transparent text-3xl font-black w-full outline-none text-slate-800">
                    </div>
                </div>

                <button @click="startGame" class="w-full bg-red-600 text-white py-6 rounded-[2rem] font-black text-3xl shadow-2xl mt-6 active:translate-y-2 transition uppercase italic">
                    {{ t.startBtn }}
                </button>
            </div>

            <div v-else class="flex-grow flex flex-col h-full overflow-hidden bg-slate-50">
                <div class="bg-slate-900 text-white p-5 shadow-2xl z-10 border-b-2 border-white/5">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-5">
                            <div class="w-24 h-24 bg-white rounded-[2rem] flex items-center justify-center text-slate-900 text-6xl font-black border-b-[10px] border-red-600 animate-pop" :key="currentNumber">
                                {{ currentNumber || '--' }}
                            </div>
                            <div>
                                <p class="text-xs text-red-500 font-black italic uppercase tracking-[0.2em]">{{ t.drawnLabel }}</p>
                                <p class="text-4xl font-black tracking-tighter">{{ drawnHistory.length }}<span class="text-lg opacity-30 font-normal ml-1">/90</span></p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-3">
                            <button v-if="mode === 'MULTI'" @click="showShareModal = true" class="bg-red-600 text-[10px] px-4 py-2.5 rounded-2xl font-black shadow-lg flex items-center uppercase active:scale-95 transition">
                                <i class="fas fa-qrcode mr-2 text-sm"></i> {{ t.inviteBtn }}
                            </button>
                            <div class="flex flex-col items-center">
                                <button v-if="isAuto" @click="togglePause" class="w-14 h-14 rounded-full bg-white text-slate-900 flex items-center justify-center shadow-2xl active:scale-90 transition">
                                    <i :class="isPaused ? 'fas fa-play ml-1' : 'fas fa-pause'"></i>
                                </button>
                                <button v-else @click="drawNext" class="w-14 h-14 rounded-full bg-red-600 text-white flex items-center justify-center shadow-2xl active:scale-90 transition">
                                    <i class="fas fa-forward"></i>
                                </button>
                                <span class="text-[9px] font-black mt-2 uppercase opacity-60">{{ isAuto ? (isPaused ? t.playText : t.pauseText) : t.nextBtn }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-5 pt-4 border-t border-white/10 overflow-hidden">
                        <div class="flex items-center space-x-3 overflow-x-auto no-scrollbar py-2 px-1">
                            <div v-for="(n, idx) in [...drawnHistory].reverse()" :key="idx" 
                                 class="history-item" 
                                 :class="[idx === 0 ? 'history-latest' : '', myNumbers.includes(n) ? 'history-match' : '']">
                                {{ n }}
                            </div>
                            <div v-if="drawnHistory.length === 0" class="text-xs text-white/20 font-black italic uppercase tracking-widest py-2">{{ t.historyEmpty }}</div>
                        </div>
                    </div>
                </div>

                <div class="flex-grow overflow-y-auto p-4 space-y-6 no-scrollbar">
                    <div v-for="(card, cIdx) in myCards" :key="cIdx" class="bg-white p-3 rounded-3xl shadow-xl border-2 border-slate-200">
                        <div v-for="(row, rIdx) in card" :key="rIdx" class="grid grid-cols-9 gap-1.5 mb-1.5">
                            <div v-for="(num, nIdx) in row" :key="nIdx" 
                                @click="toggleMark(cIdx, rIdx, nIdx)"
                                class="cell rounded-lg" :class="[num === 0 ? 'bg-slate-50/50 border-none opacity-0' : '', isMarked(cIdx, rIdx, nIdx) ? 'marked' : '']">
                                <span class="cell-num">{{ num !== 0 ? num : '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="pt-6 pb-28">
                        <button @click="checkKinh" class="w-full bg-red-600 text-white py-10 rounded-[3rem] font-black text-5xl italic shadow-2xl active:scale-95 transition border-b-[12px] border-red-800 uppercase">
                            {{ t.kinhBtn }}
                        </button>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-1 right-2 pointer-events-none text-[8px] text-slate-300 font-mono">
                System: Gemini 3 Flash / Last Update: 2026-02-09 / Rev: 12
            </div>
        </main>

        <div v-if="showShareModal" class="fixed inset-0 z-50 flex items-center justify-center p-8 bg-black/90 backdrop-blur-lg animate-pop">
            <div class="bg-white rounded-[3rem] w-full p-10 text-center space-y-8 shadow-2xl border-t-[12px] border-red-600">
                <h3 class="font-black text-3xl italic text-red-600 uppercase">{{ t.inviteTitle }}</h3>
                <div id="qrcode" class="flex justify-center p-6 bg-white rounded-[2rem] border-4 border-slate-100 shadow-inner"></div>
                <div class="grid grid-cols-2 gap-4 pt-2">
                    <button @click="copyLink" class="bg-slate-900 text-white py-5 rounded-2xl font-black text-sm uppercase shadow-lg">{{ t.copyBtn }}</button>
                    <button @click="showShareModal = false" class="bg-slate-100 text-slate-400 py-5 rounded-2xl font-black text-sm uppercase">{{ t.closeBtn }}</button>
                </div>
            </div>
        </div>

        <div v-if="showWalletModal" class="fixed inset-0 z-50 flex items-center justify-center p-8 bg-black/90 backdrop-blur-lg animate-pop">
            <div class="bg-white rounded-[3rem] w-full p-10 space-y-8 shadow-2xl border-t-[12px] border-green-500">
                <h3 class="font-black text-3xl italic text-green-600 uppercase flex items-center justify-center"><i class="fas fa-wallet mr-4"></i>{{ t.walletTitle }}</h3>
                <div class="space-y-5 text-left">
                    <div class="bg-slate-50 p-6 rounded-3xl border-2">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1 block">{{ t.curLabel }}</label>
                        <input type="text" v-model="tempWallet.currency" class="w-full bg-transparent font-black text-2xl outline-none">
                    </div>
                    <div class="bg-slate-50 p-6 rounded-3xl border-2">
                        <label class="text-xs font-black text-slate-400 uppercase tracking-widest mb-1 block">{{ t.balLabel }}</label>
                        <input type="number" v-model.number="tempWallet.amount" class="w-full bg-transparent font-black text-4xl outline-none">
                    </div>
                </div>
                <div class="flex gap-4 pt-2">
                    <button @click="showWalletModal = false" class="flex-1 py-5 text-slate-400 font-bold uppercase tracking-widest text-sm">{{ t.cancel }}</button>
                    <button @click="saveWallet" class="flex-1 bg-green-600 text-white py-5 rounded-2xl font-black shadow-xl uppercase tracking-widest text-sm active:scale-95 transition">
                        {{ t.saveBtn }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAqKCaLzCoGY6e87gHmeRAAawN5yrVeFcg",
            authDomain: "loto-vn.firebaseapp.com",
            databaseURL: "https://loto-vn-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "loto-vn",
            storageBucket: "loto-vn.firebasestorage.app",
            messagingSenderId: "403754138736",
            appId: "1:403754138736:web:9e8927bf43a86f299bc8b5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // LANGUAGES
        const i18n = {
            vi: { langName: "Tiếng Việt", cur: "₫", defWallet: 500000, defBet: 10000, welcomeMsg: "Chào mừng", playerNameLabel: "Tên người chơi", placeholderName: "Nhập tên...", soloMode: "Solo", multiMode: "Multiplayer", setupTitle: "Thiết lập", ticketCount: "Số vé", drawMethod: "Cách quay", speedLabel: "Tốc độ", betAmount: "Mức cược", startBtn: "BẮT ĐẦU", drawnLabel: "Số đã bốc", nextBtn: "Tiếp theo", playText: "Chạy", pauseText: "Dừng", homeBtn: "Home", historyEmpty: "Trống", kinhBtn: "KINH!", winMsg: "CHIẾN THẮNG!", loseMsg: "Chưa Kinh!", walletLabel: "Số dư", quitConfirm: "Thoát game?", inviteBtn: "Mời", inviteTitle: "Mời Tham Gia", copyBtn: "Copy", closeBtn: "Đóng", walletTitle: "Ví", curLabel: "Đơn vị", balLabel: "Số dư", cancel: "Hủy", saveBtn: "Lưu", fullMsg: "Phòng đầy" },
            ja: { langName: "日本語", cur: "¥", defWallet: 3000, defBet: 100, welcomeMsg: "ようこそ", playerNameLabel: "プレイヤー名", placeholderName: "名前を入力...", soloMode: "ソロプレイ", multiMode: "マルチプレイ", setupTitle: "ゲーム設定", ticketCount: "チケット枚数", drawMethod: "抽選方法", speedLabel: "自動の間隔", betAmount: "賭け金", startBtn: "開始", drawnLabel: "出た数字", nextBtn: "次を引く", playText: "再開", pauseText: "停止", homeBtn: "ホーム", historyEmpty: "履歴なし", kinhBtn: "上がり！", winMsg: "おめでとう！上がりです！", loseMsg: "まだ上がっていません", walletLabel: "残高", quitConfirm: "ホームに戻りますか？", inviteBtn: "招待", inviteTitle: "ルーム招待", copyBtn: "コピー", closeBtn: "閉じる", walletTitle: "ウォレット", curLabel: "通貨単位", balLabel: "残高設定", cancel: "戻る", saveBtn: "保存", fullMsg: "満員です" },
            en: { langName: "English", cur: "$", defWallet: 20, defBet: 1, welcomeMsg: "Welcome", playerNameLabel: "Player Name", placeholderName: "Enter name...", soloMode: "Solo", multiMode: "Multi", setupTitle: "Setup", ticketCount: "Tickets", drawMethod: "Method", speedLabel: "Speed", betAmount: "Bet", startBtn: "START", drawnLabel: "Drawn", nextBtn: "Next", playText: "Play", pauseText: "Pause", homeBtn: "Home", historyEmpty: "Empty", kinhBtn: "KINH!", winMsg: "WINNER!", loseMsg: "Not yet!", walletLabel: "Wallet", quitConfirm: "Quit?", inviteBtn: "Invite", inviteTitle: "Invitation", copyBtn: "Copy", closeBtn: "Close", walletTitle: "Wallet", curLabel: "Currency", balLabel: "Balance", cancel: "Cancel", saveBtn: "Save", fullMsg: "Full" },
            th: { langName: "ไทย", cur: "฿", defWallet: 500, defBet: 20, welcomeMsg: "ยินดีต้อนรับ", playerNameLabel: "ชื่อผู้เล่น", placeholderName: "กรอกชื่อ...", soloMode: "เล่นคนเดียว", multiMode: "เล่นหลายคน", setupTitle: "ตั้งค่า", ticketCount: "จำนวนใบ", drawMethod: "วิธีจั่ว", speedLabel: "ความเร็ว", betAmount: "เดิมพัน", startBtn: "เริ่ม", drawnLabel: "จั่วแล้ว", nextBtn: "ถัดไป", playText: "เล่น", pauseText: "หยุด", homeBtn: "หน้าหลัก", historyEmpty: "ไม่มีประวัติ", kinhBtn: "คิน!", winMsg: "คุณชนะ!", loseMsg: "ยัง!", walletLabel: "ยอดเงิน", quitConfirm: "ออก?", inviteBtn: "เชิญ", inviteTitle: "เชิญเพื่อน", copyBtn: "คัดลอก", closeBtn: "ปิด", walletTitle: "กระเป๋า", curLabel: "สกุลเงิน", balLabel: "ยอด", cancel: "ยกเลิก", saveBtn: "บันทึก", fullMsg: "เต็ม" },
            lo: { langName: "ລາວ", cur: "₭", defWallet: 500000, defBet: 10000, welcomeMsg: "ຍິນດີຕ້ອນຮັບ", playerNameLabel: "ຊື່ຜູ້ຫຼິ້ນ", placeholderName: "ໃສ່ຊື່...", soloMode: "ຫຼິ້ນຄົນດຽວ", multiMode: "ຫຼິ້ນຫຼາຍຄົນ", setupTitle: "ຕັ້ງຄ່າ", ticketCount: "ໃບ", drawMethod: "ວິທີ", speedLabel: "ຄວາມໄວ", betAmount: "ເດີມພັນ", startBtn: "ເລີ່ມ", drawnLabel: "ອອກແລ້ວ", nextBtn: "ຕໍ່ໄປ", playText: "ຫຼິ້ນ", pauseText: "ຢຸດ", homeBtn: "ໜ້າຫຼັກ", historyEmpty: "ບໍ່ມີປະຫວັດ", kinhBtn: "ກິນ!", winMsg: "ຊະນະ!", loseMsg: "ຍັງ!", walletLabel: "ຍອດ", quitConfirm: "ອອກ?", inviteBtn: "ເຊີນ", inviteTitle: "ເຊີນ", copyBtn: "ຄັດລອກ", closeBtn: "ປິດ", walletTitle: "ກະເປົາ", curLabel: "ສະກຸນ", balLabel: "ຍອດ", cancel: "ຍົກເລີກ", saveBtn: "ບັນທຶກ", fullMsg: "ເຕັມ" },
            km: { langName: "ខ្មែរ", cur: "៛", defWallet: 80000, defBet: 2000, welcomeMsg: "សូមស្វាគមន៍", playerNameLabel: "ឈ្មោះអ្នកលេង", placeholderName: "បញ្ចូលឈ្មោះ...", soloMode: "ម្នាក់ឯង", multiMode: "ច្រើននាក់", setupTitle: "ការកំណត់", ticketCount: "សន្លឹក", drawMethod: "វិធី", speedLabel: "ល្បឿន", betAmount: "ភ្នាល់", startBtn: "ផ្ដើម", drawnLabel: "ចេញហើយ", nextBtn: "បន្ទាប់", playText: "បន្ត", pauseText: "ឈប់", homeBtn: "មេ", historyEmpty: "គ្មានប្រវត្តិ", kinhBtn: "គីន!", winMsg: "ឈ្នះ!", loseMsg: "នៅ!", walletLabel: "សមតុល្យ", quitConfirm: "ចេញ?", inviteBtn: "អញ្ជើញ", inviteTitle: "អញ្ជើញ", copyBtn: "ចម្លង", closeBtn: "បិទ", walletTitle: "កាបូប", curLabel: "រូបិយ", balLabel: "សមតុល្យ", cancel: "បោះបង់", saveBtn: "រក្សា", fullMsg: "ពេញ" },
            zh: { langName: "简体中文", cur: "¥", defWallet: 150, defBet: 5, welcomeMsg: "欢迎", playerNameLabel: "姓名", placeholderName: "输入...", soloMode: "单人", multiMode: "多人", setupTitle: "设置", ticketCount: "票数", drawMethod: "方式", speedLabel: "速度", betAmount: "下注", startBtn: "开始", drawnLabel: "已抽", nextBtn: "下个", playText: "继续", pauseText: "暂停", homeBtn: "首页", historyEmpty: "暂无数据", kinhBtn: "赢了!", winMsg: "恭喜!", loseMsg: "未中!", walletLabel: "余额", quitConfirm: "退出?", inviteBtn: "邀请", inviteTitle: "邀请好友", copyBtn: "复制", closeBtn: "关闭", walletTitle: "钱包", curLabel: "货币", balLabel: "余额", cancel: "取消", saveBtn: "保存", fullMsg: "满员" },
            fr: { langName: "Français", cur: "€", defWallet: 20, defBet: 1, welcomeMsg: "Bienvenue", playerNameLabel: "Nom", placeholderName: "Nom...", soloMode: "Solo", multiMode: "Multi", setupTitle: "Réglage", ticketCount: "Tickets", drawMethod: "Mode", speedLabel: "Vitesse", betAmount: "Mise", startBtn: "JOUER", drawnLabel: "Tirés", nextBtn: "Suiv.", playText: "Play", pauseText: "Pause", homeBtn: "Home", historyEmpty: "Vide", kinhBtn: "KINH!", winMsg: "Gagné!", loseMsg: "Non!", walletLabel: "Solde", quitConfirm: "Quitter?", inviteBtn: "Inviter", inviteTitle: "Invitation", copyBtn: "Copier", closeBtn: "Fermer", walletTitle: "Porte-monnaie", curLabel: "Devise", balLabel: "Solde", cancel: "Annuler", saveBtn: "Sauver", fullMsg: "Plein" }
        };

        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;
        createApp({
            setup() {
                // Reactive State
                const currentLang = ref(localStorage.getItem('loto_lang') || 'ja');
                const t = computed(() => i18n[currentLang.value] || i18n.ja);
                const gameState = ref('HOME');
                const mode = ref('SOLO');
                const playerName = ref(localStorage.getItem('loto_player_name') || '');
                const wallet = reactive({ amount: 3000, currency: '¥' });
                const tempWallet = reactive({ amount: 0, currency: '' });
                const showWalletModal = ref(false);
                const showShareModal = ref(false);
                const ticketCount = ref(1);
                const betAmount = ref(100);
                const isAuto = ref(true);
                const drawInterval = ref(4);
                const isPaused = ref(false);
                const myCards = ref([]);
                const myMarks = ref([]);
                const currentNumber = ref(null);
                const drawnHistory = ref([]);
                const roomId = ref(new URLSearchParams(window.location.search).get('room'));
                const isMaster = ref(false);
                let timer = null;

                // Computed
                const myNumbers = computed(() => {
                    let nums = [];
                    myCards.value.forEach(card => card.forEach(row => row.forEach(n => { if(n !== 0) nums.push(n); })));
                    return nums;
                });

                // Methods
                const saveState = () => {
                    if (gameState.value === 'PLAYING') {
                        const data = {
                            gs: gameState.value, m: mode.value, c: myCards.value, mk: myMarks.value,
                            tc: ticketCount.value, ba: betAmount.value, ia: isAuto.value, di: drawInterval.value,
                            ri: roomId.value, im: isMaster.value, wal: wallet.amount, cur: wallet.currency,
                            his: drawnHistory.value
                        };
                        localStorage.setItem('loto_session', JSON.stringify(data));
                    }
                };

                // Watch for auto-mark
                watch(currentNumber, (newVal) => {
                    if (!newVal || !isAuto.value) return;
                    myCards.value.forEach((card, cIdx) => {
                        card.forEach((row, rIdx) => {
                            row.forEach((num, nIdx) => {
                                if (num === newVal) {
                                    myMarks.value[cIdx][rIdx][nIdx] = true;
                                }
                            });
                        });
                    });
                    saveState();
                });

                const handleLangChange = () => {
                    localStorage.setItem('loto_lang', currentLang.value);
                };

                const initGame = async (m) => {
                    mode.value = m;
                    const safeName = playerName.value.trim().replace(/[.#$[\]]/g, "_") || 'Player_' + Math.floor(Math.random()*900+100);
                    playerName.value = safeName;
                    localStorage.setItem('loto_player_name', safeName);

                    if(m === 'MULTI') {
                        if(!roomId.value) {
                            roomId.value = Math.random().toString(36).substring(2, 7).toUpperCase();
                            isMaster.value = true;
                        }
                        const url = new URL(window.location.href);
                        url.searchParams.set('room', roomId.value);
                        window.history.pushState({}, '', url);

                        const pRef = db.ref(`rooms/${roomId.value}/players`);
                        const snapshot = await pRef.once('value');
                        if(!isMaster.value && !snapshot.exists()) isMaster.value = true;
                        pRef.child(safeName).set(true);
                    }
                    gameState.value = 'SETUP';
                };

                const stopAllProcesses = () => {
                    if(timer) clearInterval(timer);
                    timer = null;
                    if(mode.value === 'MULTI' && roomId.value) {
                        db.ref(`rooms/${roomId.value}`).off();
                    }
                    isPaused.value = false;
                    localStorage.removeItem('loto_session');
                };

                const startGame = () => {
                    if(gameState.value !== 'PLAYING') {
                        const totalBet = betAmount.value * ticketCount.value;
                        if(wallet.amount < totalBet) return alert("Insufficient balance");
                        wallet.amount -= totalBet;
                        
                        // 生成：重複なしチケット
                        myCards.value = generateUniqueCards(ticketCount.value);
                        myMarks.value = myCards.value.map(c => c.map(r => r.map(() => false)));
                        drawnHistory.value = [];
                        currentNumber.value = null;
                    }
                    
                    gameState.value = 'PLAYING';
                    saveState();
                    
                    if(mode.value === 'MULTI') {
                        const rRef = db.ref(`rooms/${roomId.value}`);
                        rRef.on('value', s => {
                            const d = s.val();
                            if(d && d.his){
                                drawnHistory.value = d.his;
                                currentNumber.value = d.his[d.his.length - 1];
                                saveState();
                            }
                        });
                    }

                    if(isAuto.value && (mode.value === 'SOLO' || isMaster.value)) {
                        startTimer();
                    }
                };

                const startTimer = () => {
                    if(timer) clearInterval(timer);
                    timer = setInterval(() => {
                        if(!isPaused.value && drawnHistory.value.length < 90) {
                            drawNext();
                        }
                    }, drawInterval.value * 1000);
                };

                const drawNext = () => {
                    if(drawnHistory.value.length >= 90) return;
                    let n;
                    do {
                        n = Math.floor(Math.random() * 90) + 1;
                    } while(drawnHistory.value.includes(n));

                    if(mode.value === 'SOLO') {
                        drawnHistory.value.push(n);
                        currentNumber.value = n;
                        saveState();
                    } else if(isMaster.value) {
                        db.ref(`rooms/${roomId.value}`).update({
                            his: [...drawnHistory.value, n]
                        });
                    }
                };

                const generateUniqueCards = (count) => {
                    const colBounds = [[1,9],[10,19],[20,29],[30,39],[40,49],[50,59],[60,69],[70,79],[80,90]];
                    let usedGlobal = new Set();
                    
                    return Array.from({length: count}, () => {
                        let card = [Array(9).fill(0), Array(9).fill(0), Array(9).fill(0)];
                        for(let r=0; r<3; r++){
                            let cols = [0,1,2,3,4,5,6,7,8].sort(()=>Math.random()-0.5).slice(0,5).sort();
                            cols.forEach(c => {
                                let [min, max] = colBounds[c];
                                let n;
                                let attempts = 0;
                                do {
                                    n = Math.floor(Math.random() * (max - min + 1)) + min;
                                    attempts++;
                                } while((usedGlobal.has(n) || card[0][c]===n || card[1][c]===n || card[2][c]===n) && attempts < 100);
                                
                                card[r][c] = n;
                                usedGlobal.add(n);
                            });
                        }
                        return card;
                    });
                };

                const checkKinh = () => {
                    const win = myMarks.value.some((card, cIdx) => {
                        return card.some((row, rIdx) => {
                            const numsInRow = myCards.value[cIdx][rIdx].filter(n => n !== 0);
                            const marksInRow = myCards.value[cIdx][rIdx].filter((n, nIdx) => n !== 0 && row[nIdx]);
                            return numsInRow.length === 5 && marksInRow.length === 5 && marksInRow.every(n => drawnHistory.value.includes(n));
                        });
                    });

                    if(win) {
                        alert(t.value.winMsg);
                        wallet.amount += (betAmount.value * 10);
                        exitToHome();
                    } else {
                        alert(t.value.loseMsg);
                    }
                };

                const exitToHome = async () => {
                    stopAllProcesses();
                    if(mode.value === 'MULTI' && roomId.value) {
                        await db.ref(`rooms/${roomId.value}/players/${playerName.value}`).remove();
                        const s = await db.ref(`rooms/${roomId.value}/players`).once('value');
                        if(!s.exists()) await db.ref(`rooms/${roomId.value}`).remove();
                    }
                    gameState.value = 'HOME';
                    const url = new URL(window.location.href);
                    url.searchParams.delete('room');
                    window.history.pushState({}, '', url);
                    roomId.value = null;
                };

                const togglePause = () => isPaused.value = !isPaused.value;
                const confirmQuit = () => { if(confirm(t.value.quitConfirm)) exitToHome(); };
                
                // オートモード時は手動操作を無効化
                const toggleMark = (cIdx, rIdx, nIdx) => {
                    if (isAuto.value) return; 
                    if (myCards.value[cIdx][rIdx][nIdx] !== 0) {
                        myMarks.value[cIdx][rIdx][nIdx] = !myMarks.value[cIdx][rIdx][nIdx];
                        saveState();
                    }
                };

                const isMarked = (cIdx, rIdx, nIdx) => myMarks.value[cIdx]?.[rIdx]?.[nIdx];
                const openWalletModal = () => {
                    tempWallet.amount = wallet.amount;
                    tempWallet.currency = wallet.currency;
                    showWalletModal.value = true;
                };
                const saveWallet = () => {
                    wallet.amount = tempWallet.amount;
                    wallet.currency = tempWallet.currency;
                    showWalletModal.value = false;
                    localStorage.setItem('loto_wallet', JSON.stringify(wallet));
                };
                const copyLink = () => {
                    navigator.clipboard.writeText(window.location.href);
                    alert("Link copied!");
                };

                watch(showShareModal, (v) => {
                    if(v) {
                        setTimeout(() => {
                            const qrEl = document.getElementById('qrcode');
                            qrEl.innerHTML = "";
                            new QRCode(qrEl, { text: window.location.href, width: 200, height: 200 });
                        }, 100);
                    }
                });

                // Lifecycle
                onMounted(() => {
                    const saved = localStorage.getItem('loto_session');
                    if (saved) {
                        const d = JSON.parse(saved);
                        // 完全復元
                        gameState.value = d.gs;
                        mode.value = d.m;
                        myCards.value = d.c;
                        myMarks.value = d.mk;
                        ticketCount.value = d.tc;
                        betAmount.value = d.ba;
                        isAuto.value = d.ia;
                        drawInterval.value = d.di;
                        roomId.value = d.ri;
                        isMaster.value = d.im;
                        wallet.amount = d.wal;
                        wallet.currency = d.cur;
                        drawnHistory.value = d.his || [];
                        currentNumber.value = drawnHistory.value.length > 0 ? drawnHistory.value[drawnHistory.value.length - 1] : null;

                        if (gameState.value === 'PLAYING') {
                            if(mode.value === 'MULTI') {
                                const rRef = db.ref(`rooms/${roomId.value}`);
                                rRef.on('value', s => {
                                    const data = s.val();
                                    if(data && data.his){
                                        drawnHistory.value = data.his;
                                        currentNumber.value = data.his[data.his.length - 1];
                                        saveState();
                                    }
                                });
                            }
                            if(isAuto.value && (mode.value === 'SOLO' || isMaster.value)) startTimer();
                        }
                    } else if (roomId.value) {
                        initGame('MULTI');
                    }
                    
                    const savedWal = localStorage.getItem('loto_wallet');
                    if(savedWal) Object.assign(wallet, JSON.parse(savedWal));
                });

                return {
                    currentLang, t, i18n, gameState, mode, playerName, wallet, tempWallet,
                    showWalletModal, showShareModal, ticketCount, betAmount, isAuto,
                    drawInterval, isPaused, myCards, currentNumber, drawnHistory,
                    myNumbers, handleLangChange, initGame, startGame, drawNext,
                    checkKinh, confirmQuit, toggleMark, isMarked, openWalletModal,
                    saveWallet, copyLink, togglePause
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
