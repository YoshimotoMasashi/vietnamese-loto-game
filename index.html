<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LÃ´ TÃ´ Global - Ultimate Fixed Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        [v-cloak] { display: none; }
        .cell { aspect-ratio: 1/1; font-weight: 800; display: flex; align-items: center; justify-content: center; border: 1px solid #e2e8f0; font-size: 0.85rem; background: white; transition: all 0.2s; position: relative; cursor: pointer; }
        .marked::after { content: ''; position: absolute; width: 80%; height: 80%; background-color: rgba(239, 68, 68, 0.85); border-radius: 50%; z-index: 10; animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .cell-num { z-index: 20; }
        .marked .cell-num { color: white; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    <div id="app" v-cloak class="min-h-screen max-w-md mx-auto flex flex-col bg-white shadow-2xl relative overflow-hidden">
        
        <div class="fixed top-20 left-0 right-0 z-[60] px-6 pointer-events-none">
            <div v-for="log in logs" :key="log.id" class="bg-black/80 text-white text-xs py-2.5 px-5 rounded-full shadow-xl mb-2 text-center animate-pop">
                {{ log.message }}
            </div>
        </div>

        <header class="p-3 bg-white border-b flex justify-between items-center sticky top-0 z-40 h-16">
            <button v-if="gameState !== 'HOME'" @click="confirmQuit" class="flex items-center justify-center w-10 h-10 bg-slate-100 text-slate-600 rounded-full">
                <i class="fas fa-home"></i>
            </button>
            <div v-else class="w-10"></div>

            <select v-model="currentLang" @change="handleLangChange" class="text-xs font-bold bg-slate-50 border rounded-lg px-2 py-1.5 outline-none border-red-100">
                <option v-for="(l, code) in i18n" :key="code" :value="code">{{ l.langName }}</option>
            </select>
            
            <button @click="openWalletModal" class="flex items-center bg-green-50 px-3 py-1.5 rounded-xl border border-green-100">
                <div class="flex flex-col items-end mr-2">
                    <span class="text-[10px] text-green-700 font-black leading-none uppercase tracking-tighter">{{ t.walletLabel }}</span>
                    <span class="font-black text-green-600 text-xl leading-tight">{{ wallet.currency }}{{ wallet.amount.toLocaleString() }}</span>
                </div>
                <i class="fas fa-pen-to-square text-green-400 text-sm"></i>
            </button>
        </header>

        <main class="flex-grow flex flex-col overflow-hidden">
            <div v-if="gameState === 'HOME'" class="flex-grow p-8 flex flex-col justify-center space-y-6">
                <div class="text-center space-y-2">
                    <h1 class="text-6xl font-black text-red-600 italic tracking-tighter drop-shadow-sm">LÃ” TÃ”</h1>
                    <p class="text-[10px] text-slate-400 font-black tracking-[0.4em] uppercase">{{ t.welcomeMsg }}</p>
                </div>

                <div class="bg-slate-50 p-4 rounded-3xl border-2 border-slate-100">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-2 block">{{ t.playerNameLabel }}</label>
                    <input type="text" v-model="playerName" class="w-full bg-transparent text-xl font-black px-2 outline-none text-slate-700" :placeholder="t.placeholderName">
                </div>

                <div class="space-y-4">
                    <button @click="initGame('SOLO')" class="w-full bg-slate-900 text-white p-6 rounded-[2rem] flex items-center shadow-xl active:scale-95 transition">
                        <i class="fas fa-play text-2xl mr-5"></i>
                        <div class="text-left"><p class="font-black text-lg">{{ t.soloMode }}</p></div>
                    </button>
                    <button @click="initGame('MULTI')" class="w-full bg-red-600 text-white p-6 rounded-[2rem] flex items-center shadow-xl active:scale-95 transition">
                        <i class="fas fa-users text-2xl mr-5"></i>
                        <div class="text-left"><p class="font-black text-lg">{{ t.multiMode }}</p></div>
                    </button>
                </div>
            </div>

            <div v-else-if="gameState === 'SETUP'" class="flex-grow p-8 space-y-5 overflow-y-auto no-scrollbar">
                <h2 class="text-center font-black text-2xl text-slate-800 italic uppercase underline decoration-red-500 decoration-4 underline-offset-8 mb-4">{{ t.setupTitle }}</h2>
                
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">{{ t.ticketCount }}</label>
                    <div class="grid grid-cols-4 gap-3">
                        <button v-for="n in 4" :key="n" @click="ticketCount = n" :class="ticketCount === n ? 'bg-red-600 text-white shadow-lg' : 'bg-slate-100 text-slate-400'" class="py-4 rounded-2xl font-black transition">{{ n }}</button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">{{ t.drawMethod }}</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button @click="isAuto = true" :class="isAuto ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-400'" class="py-4 rounded-2xl font-black transition">AUTO</button>
                        <button @click="isAuto = false" :class="!isAuto ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-400'" class="py-4 rounded-2xl font-black transition">MANUAL</button>
                    </div>
                </div>

                <div v-if="isAuto" class="space-y-2 bg-slate-50 p-4 rounded-2xl">
                    <div class="flex justify-between"><label class="text-[10px] font-black text-slate-400 uppercase">{{ t.speedLabel }}</label><span class="text-xs font-black text-red-600">{{ drawInterval }}s</span></div>
                    <input type="range" v-model="drawInterval" min="2" max="8" step="1" class="w-full accent-red-600">
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">{{ t.betAmount }}</label>
                    <div class="flex items-center bg-slate-50 p-4 rounded-2xl border-2">
                        <span class="font-black text-slate-400 text-xl mr-3">{{ wallet.currency }}</span>
                        <input type="number" v-model.number="betAmount" class="bg-transparent text-2xl font-black w-full outline-none">
                    </div>
                </div>

                <button @click="startGame" class="w-full bg-red-600 text-white py-6 rounded-3xl font-black text-2xl shadow-2xl mt-4 active:translate-y-1 transition">
                    {{ t.startBtn }}
                </button>
            </div>

            <div v-else class="flex-grow flex flex-col h-full overflow-hidden">
                <div class="bg-slate-900 text-white p-4 shadow-2xl space-y-3">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-4">
                            <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center text-slate-900 text-5xl font-black border-b-8 border-red-600 animate-pop" :key="currentNumber">
                                {{ currentNumber || '--' }}
                            </div>
                            <div>
                                <p class="text-[10px] text-red-500 font-black italic uppercase tracking-widest">{{ t.drawnLabel }}</p>
                                <p class="text-2xl font-black">{{ drawnHistory.length }}<span class="text-xs opacity-30">/90</span></p>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <button v-if="mode === 'MULTI'" @click="showShareModal = true" class="bg-red-600 text-[10px] px-3 py-2 rounded-xl font-black shadow-lg flex items-center">
                                <i class="fas fa-qrcode mr-2"></i> {{ t.inviteBtn }}
                            </button>
                            <div class="flex gap-2">
                                <button v-if="isAuto" @click="togglePause" class="w-10 h-10 rounded-full bg-white text-slate-900 flex items-center justify-center shadow-lg active:scale-90 transition">
                                    <i :class="isPaused ? 'fas fa-play' : 'fas fa-pause'"></i>
                                </button>
                                <button v-if="!isAuto" @click="drawNext" class="px-4 py-2 rounded-xl bg-red-600 text-white font-black text-xs shadow-lg active:scale-95 transition">
                                    {{ t.nextBtn }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-grow overflow-y-auto p-4 space-y-5 no-scrollbar bg-slate-50">
                    <div v-for="(card, cIdx) in myCards" :key="cIdx" class="bg-white p-2.5 rounded-2xl shadow-sm border border-slate-200">
                        <div v-for="(row, rIdx) in card" :key="rIdx" class="grid grid-cols-9 gap-1 mb-1">
                            <div v-for="(num, nIdx) in row" :key="nIdx" 
                                @click="toggleMark(cIdx, rIdx, nIdx)"
                                class="cell" :class="[num === 0 ? 'bg-slate-50/50 border-none' : '', isMarked(cIdx, rIdx, nIdx) ? 'marked' : '']">
                                <span class="cell-num">{{ num !== 0 ? num : '' }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 pb-24 text-center">
                        <button @click="checkKinh" class="w-full bg-red-600 text-white py-8 rounded-[2rem] font-black text-4xl italic shadow-2xl active:scale-95 transition">
                            {{ t.kinhBtn }}
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <div v-if="showShareModal" class="fixed inset-0 z-50 flex items-center justify-center p-8 bg-black/80 backdrop-blur-md animate-pop">
            <div class="bg-white rounded-[2.5rem] w-full p-8 text-center space-y-6 shadow-2xl border-t-8 border-red-600">
                <h3 class="font-black text-2xl italic text-red-600 uppercase">{{ t.inviteTitle }}</h3>
                <div id="qrcode" class="flex justify-center p-4 bg-white rounded-3xl border shadow-inner"></div>
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button @click="copyLink" class="bg-slate-900 text-white py-4 rounded-2xl font-black text-xs uppercase">{{ t.copyBtn }}</button>
                    <button @click="showShareModal = false" class="bg-slate-100 text-slate-400 py-4 rounded-2xl font-black text-xs uppercase">{{ t.closeBtn }}</button>
                </div>
            </div>
        </div>

        <div v-if="showWalletModal" class="fixed inset-0 z-50 flex items-center justify-center p-8 bg-black/80 backdrop-blur-md animate-pop">
            <div class="bg-white rounded-[2.5rem] w-full p-8 space-y-6 shadow-2xl border-t-8 border-green-500">
                <h3 class="font-black text-2xl italic text-green-600"><i class="fas fa-wallet mr-2"></i>{{ t.walletTitle }}</h3>
                <div class="space-y-4">
                    <div class="bg-slate-50 p-4 rounded-2xl border"><label class="text-[10px] font-black text-slate-400">{{ t.curLabel }}</label><input type="text" v-model="tempWallet.currency" class="w-full bg-transparent font-black text-xl outline-none"></div>
                    <div class="bg-slate-50 p-4 rounded-2xl border"><label class="text-[10px] font-black text-slate-400">{{ t.balLabel }}</label><input type="number" v-model.number="tempWallet.amount" class="w-full bg-transparent font-black text-3xl outline-none"></div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button @click="showWalletModal = false" class="flex-1 py-4 text-slate-400 font-bold">{{ t.cancel }}</button>
                    <button @click="saveWallet" class="flex-1 bg-green-600 text-white py-4 rounded-2xl font-black shadow-lg uppercase">{{ t.saveBtn }}</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAqKCaLzCoGY6e87gHmeRAAawN5yrVeFcg",
            authDomain: "loto-vn.firebaseapp.com",
            databaseURL: "https://loto-vn-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "loto-vn",
            storageBucket: "loto-vn.firebasestorage.app",
            messagingSenderId: "403754138736",
            appId: "1:403754138736:web:9e8927bf43a86f299bc8b5",
            measurementId: "G-R4Q6NS3MT8"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const i18n = {
            vi: { langName: "Tiáº¿ng Viá»‡t", cur: "â‚«", welcomeMsg: "ChÃ o má»«ng", playerNameLabel: "TÃªn ngÆ°á»i chÆ¡i", placeholderName: "Nháº­p tÃªn...", soloMode: "ChÆ¡i má»™t mÃ¬nh", multiMode: "ChÆ¡i nhiá»u ngÆ°á»i", setupTitle: "Thiáº¿t láº­p", ticketCount: "Sá»‘ lÆ°á»£ng vÃ©", drawMethod: "CÃ¡ch quay sá»‘", speedLabel: "Tá»‘c Ä‘á»™ (giÃ¢y)", betAmount: "Má»©c cÆ°á»£c", startBtn: "Báº®T Äáº¦U", drawnLabel: "Sá»‘ Ä‘Ã£ bá»‘c", nextBtn: "TIáº¾P THEO", kinhBtn: "KINH!", winMsg: "KINH! CHIáº¾N THáº®NG!", loseMsg: "ChÆ°a Kinh!", walletLabel: "Sá»‘ dÆ°", quitConfirm: "Báº¡n cÃ³ cháº¯c muá»‘n thoÃ¡t?", inviteBtn: "Má»œI", inviteTitle: "Má»i Tham Gia", copyBtn: "Sao chÃ©p", closeBtn: "ÄÃ³ng", walletTitle: "VÃ­", curLabel: "ÄÆ¡n vá»‹", balLabel: "Sá»‘ dÆ°", cancel: "Há»§y", saveBtn: "LÆ°u", fullMsg: "PhÃ²ng Ä‘Ã£ Ä‘áº§y (10 ngÆ°á»i)" },
            en: { langName: "English", cur: "$", welcomeMsg: "Welcome", playerNameLabel: "Player Name", placeholderName: "Enter name...", soloMode: "Solo Mode", multiMode: "Multiplayer", setupTitle: "Setup Game", ticketCount: "Tickets", drawMethod: "Draw Method", speedLabel: "Speed (sec)", betAmount: "Bet Amount", startBtn: "START", drawnLabel: "Drawn", nextBtn: "NEXT", kinhBtn: "KINH!", winMsg: "KINH! WINNER!", loseMsg: "Not yet!", walletLabel: "Wallet", quitConfirm: "Are you sure you want to quit?", inviteBtn: "INVITE", inviteTitle: "Invitation", copyBtn: "Copy", closeBtn: "Close", walletTitle: "Wallet", curLabel: "Currency", balLabel: "Balance", cancel: "Cancel", saveBtn: "Save", fullMsg: "Room Full (Max 10)" },
            ja: { langName: "æ—¥æœ¬èªž", cur: "Â¥", welcomeMsg: "ã‚ˆã†ã“ã", playerNameLabel: "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å", placeholderName: "åå‰ã‚’å…¥åŠ›...", soloMode: "ã‚½ãƒ­ãƒ—ãƒ¬ã‚¤", multiMode: "ãƒžãƒ«ãƒãƒ—ãƒ¬ã‚¤", setupTitle: "ã‚²ãƒ¼ãƒ è¨­å®š", ticketCount: "ãƒã‚±ãƒƒãƒˆæžšæ•°", drawMethod: "æŠ½é¸æ–¹æ³•", speedLabel: "é€Ÿåº¦ï¼ˆç§’ï¼‰", betAmount: "è³­ã‘é‡‘", startBtn: "é–‹å§‹", drawnLabel: "å‡ºãŸæ•°å­—", nextBtn: "æ¬¡ã¸", kinhBtn: "ä¸ŠãŒã‚Šï¼", winMsg: "ãŠã‚ã§ã¨ã†ï¼ä¸ŠãŒã‚Šã§ã™ï¼", loseMsg: "ã¾ã ä¸ŠãŒã£ã¦ã„ã¾ã›ã‚“", walletLabel: "æ®‹é«˜", quitConfirm: "çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ", inviteBtn: "æ‹›å¾…", inviteTitle: "ãƒ«ãƒ¼ãƒ æ‹›å¾…", copyBtn: "ã‚³ãƒ”ãƒ¼", closeBtn: "é–‰ã˜ã‚‹", walletTitle: "ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ", curLabel: "å˜ä½", balLabel: "æ®‹é«˜", cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", saveBtn: "ä¿å­˜", fullMsg: "æº€å“¡ã§ã™(æœ€å¤§10äºº)" },
            th: { langName: "à¹„à¸—à¸¢", cur: "à¸¿", welcomeMsg: "à¸¢à¸´à¸™à¸”à¸µà¸•à¹‰à¸­à¸™à¸£à¸±à¸š", playerNameLabel: "à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™", placeholderName: "à¸à¸£à¸­à¸à¸Šà¸·à¹ˆà¸­...", soloMode: "à¹€à¸¥à¹ˆà¸™à¸„à¸™à¹€à¸”à¸µà¸¢à¸§", multiMode: "à¹€à¸¥à¹ˆà¸™à¸«à¸¥à¸²à¸¢à¸„à¸™", setupTitle: "à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¹€à¸à¸¡", ticketCount: "à¸ˆà¸³à¸™à¸§à¸™à¹ƒà¸š", drawMethod: "à¸§à¸´à¸˜à¸µà¸ˆà¸±à¹ˆà¸§", speedLabel: "à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§", betAmount: "à¹€à¸”à¸´à¸¡à¸žà¸±à¸™", startBtn: "à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸à¸¡", drawnLabel: "à¸ˆà¸±à¹ˆà¸§à¹à¸¥à¹‰à¸§", nextBtn: "à¸–à¸±à¸”à¹„à¸›", kinhBtn: "à¸„à¸´à¸™!", winMsg: "à¸„à¸¸à¸“à¸Šà¸™à¸°à¹à¸¥à¹‰à¸§!", loseMsg: "à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸Šà¸™à¸°!", walletLabel: "à¸¢à¸­à¸”à¹€à¸‡à¸´à¸™", quitConfirm: "à¸­à¸­à¸?", inviteBtn: "à¹€à¸Šà¸´à¸", inviteTitle: "à¹€à¸Šà¸´à¸à¹€à¸žà¸·à¹ˆà¸­à¸™", copyBtn: "à¸„à¸±à¸”à¸¥à¸­à¸", closeBtn: "à¸›à¸´à¸”", walletTitle: "à¸à¸£à¸°à¹€à¸›à¹‹à¸²à¹€à¸‡à¸´à¸™", curLabel: "à¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™", balLabel: "à¸¢à¸­à¸”à¹€à¸‡à¸´à¸™", cancel: "à¸¢à¸à¹€à¸¥à¸´à¸", saveBtn: "à¸šà¸±à¸™à¸—à¸¶à¸", fullMsg: "à¸«à¹‰à¸­à¸‡à¹€à¸•à¹‡à¸¡" },
            lo: { langName: "àº¥àº²àº§", cur: "â‚­", welcomeMsg: "àºàº´àº™àº”àºµàº•à»‰àº­àº™àº®àº±àºš", playerNameLabel: "àºŠàº·à»ˆàºœàº¹à»‰àº«àº¼àº´à»‰àº™", placeholderName: "à»ƒàºªà»ˆàºŠàº·à»ˆ...", soloMode: "àº«àº¼àº´à»‰àº™àº„àº»àº™àº”àº½àº§", multiMode: "àº«àº¼àº´à»‰àº™àº«àº¼àº²àºàº„àº»àº™", setupTitle: "àº•àº±à»‰àº‡àº„à»ˆàº²", ticketCount: "àºˆàº³àº™àº§àº™à»ƒàºš", drawMethod: "àº§àº´àº—àºµàº­àº­àºà»€àº¥àº", speedLabel: "àº„àº§àº²àº¡à»„àº§", betAmount: "à»€àº”àºµàº¡àºžàº±àº™", startBtn: "à»€àº¥àºµà»ˆàº¡", drawnLabel: "àº­àº­àºà»àº¥à»‰àº§", nextBtn: "àº•à»à»ˆà»„àº›", kinhBtn: "àºàº´àº™!", winMsg: "àº—à»ˆàº²àº™àºŠàº°àº™àº°à»àº¥à»‰àº§!", loseMsg: "àºàº±àº‡àºšà»à»ˆàº—àº±àº™àºàº´àº™!", walletLabel: "àºàº­àº”à»€àº‡àº´àº™", quitConfirm: "àº­àº­àº?", inviteBtn: "à»€àºŠàºµàº™", inviteTitle: "à»€àºŠàºµàº™", copyBtn: "àº„àº±àº”àº¥àº­àº", closeBtn: "àº›àº´àº”", walletTitle: "àºàº°à»€àº›àº»àº²", curLabel: "àºªàº°àºàº¸àº™", balLabel: "àºàº­àº”", cancel: "àºàº»àºà»€àº¥àºµàº", saveBtn: "àºšàº±àº™àº—àº¶àº", fullMsg: "à»€àº•àº±àº¡à»àº¥à»‰àº§" },
            km: { langName: "ážáŸ’áž˜áŸ‚ážš", cur: "áŸ›", welcomeMsg: "ážŸáž¼áž˜ážŸáŸ’ážœáž¶áž‚áž˜áž“áŸ", playerNameLabel: "ážˆáŸ’áž˜áŸ„áŸ‡áž¢áŸ’áž“áž€áž›áŸáž„", placeholderName: "áž”áž‰áŸ’áž…áž¼áž›ážˆáŸ’áž˜áŸ„áŸ‡...", soloMode: "áž›áŸáž„áž˜áŸ’áž“áž¶áž€áŸ‹áž¯áž„", multiMode: "áž›áŸáž„áž…áŸ’ážšáž¾áž“áž“áž¶áž€áŸ‹", setupTitle: "áž€áž¶ážšáž€áŸ†ážŽážáŸ‹", ticketCount: "áž…áŸ†áž“áž½áž“ážŸáž“áŸ’áž›áž¹áž€", drawMethod: "ážœáž·áž’áž¸áž…áž¶áž”áŸ‹áž›áŸáž", speedLabel: "áž›áŸ’áž”áž¿áž“", betAmount: "áž—áŸ’áž“áž¶áž›áŸ‹", startBtn: "áž…áž¶áž”áŸ‹áž•áŸ’ážŠáž¾áž˜", drawnLabel: "áž…áŸáž‰áž áž¾áž™", nextBtn: "áž”áž“áŸ’áž‘áž¶áž”áŸ‹", kinhBtn: "áž‚áž¸áž“!", winMsg: "áž¢áŸ’áž“áž€ážˆáŸ’áž“áŸ‡áž áž¾áž™!", loseMsg: "áž˜áž·áž“áž‘áž¶áž“áŸ‹áž‚áž¸áž“áž‘áŸ!", walletLabel: "ážŸáž˜ážáž»áž›áŸ’áž™", quitConfirm: "áž…áž¶áž€áž…áŸáž‰?", inviteBtn: "áž¢áž‰áŸ’áž‡áž¾áž‰", inviteTitle: "áž¢áž‰áŸ’áž‡áž¾áž‰", copyBtn: "áž…áž˜áŸ’áž›áž„", closeBtn: "áž”áž·áž‘", walletTitle: "áž€áž¶áž”áž¼áž”", curLabel: "ážšáž¼áž”áž·áž™áž”áŸážŽáŸ’ážŽ", balLabel: "ážŸáž˜ážáž»áž›áŸ’áž™", cancel: "áž”áŸ„áŸ‡áž”áž„áŸ‹", saveBtn: "ážšáž€áŸ’ážŸáž¶áž‘áž»áž€", fullMsg: "áž–áŸáž‰áž áž¾áž™" },
            zh: { langName: "ç®€ä½“ä¸­æ–‡", cur: "Â¥", welcomeMsg: "æ¬¢è¿Ž", playerNameLabel: "çŽ©å®¶å§“å", placeholderName: "è¾“å…¥åå­—...", soloMode: "å•äººæ¨¡å¼", multiMode: "å¤šäººæ¨¡å¼", setupTitle: "è®¾ç½®", ticketCount: "ç¥¨æ•°", drawMethod: "æŠ½å·æ–¹å¼", speedLabel: "é€Ÿåº¦", betAmount: "ä¸‹æ³¨é‡‘é¢", startBtn: "å¼€å§‹æ¸¸æˆ", drawnLabel: "å·²æŠ½", nextBtn: "ä¸‹ä¸€ä¸ª", kinhBtn: "èµ¢äº†!", winMsg: "æ­å–œ! ä½ èµ¢äº†!", loseMsg: "è¿˜æ²¡èµ¢å‘¢!", walletLabel: "ä½™é¢", quitConfirm: "é€€å‡ºå—?", inviteBtn: "é‚€è¯·", inviteTitle: "é‚€è¯·å¥½å‹", copyBtn: "å¤åˆ¶", closeBtn: "å…³é—­", walletTitle: "é’±åŒ…", curLabel: "è´§å¸", balLabel: "ä½™é¢", cancel: "å–æ¶ˆ", saveBtn: "ä¿å­˜", fullMsg: "æ»¡å‘˜" },
            fr: { langName: "FranÃ§ais", cur: "â‚¬", welcomeMsg: "Bienvenue", playerNameLabel: "Nom du joueur", placeholderName: "Entrez un nom...", soloMode: "Mode Solo", multiMode: "Multijoueur", setupTitle: "Configuration", ticketCount: "Tickets", drawMethod: "MÃ©thode", speedLabel: "Vitesse", betAmount: "Mise", startBtn: "JOUER", drawnLabel: "TirÃ©s", nextBtn: "SUIVANT", kinhBtn: "KINH!", winMsg: "FÃ©licitations!", loseMsg: "Pas encore!", walletLabel: "Solde", quitConfirm: "Quitter?", inviteBtn: "INVITER", inviteTitle: "Invitation", copyBtn: "Copier", closeBtn: "Fermer", walletTitle: "Portefeuille", curLabel: "Devise", balLabel: "Solde", cancel: "Annuler", saveBtn: "Sauver", fullMsg: "Complet" }
        };

        const { createApp, ref, reactive, computed, watch, onMounted } = Vue;
        createApp({
            setup() {
                const currentLang = ref(localStorage.getItem('loto_lang') || 'vi');
                const t = computed(() => i18n[currentLang.value]);
                const gameState = ref('HOME');
                const mode = ref('SOLO');
                const playerName = ref(localStorage.getItem('loto_player_name') || '');
                const wallet = reactive({ amount: 10000, currency: t.value.cur });
                const tempWallet = reactive({ amount: 0, currency: '' });
                const showWalletModal = ref(false);
                const showShareModal = ref(false);
                const ticketCount = ref(1);
                const betAmount = ref(100);
                const isAuto = ref(true);
                const drawInterval = ref(4);
                const isPaused = ref(false);
                const myCards = ref([]);
                const myMarks = ref([]);
                const currentNumber = ref(null);
                const drawnHistory = ref([]);
                const roomId = ref(new URLSearchParams(window.location.search).get('room'));
                const logs = ref([]);
                const lastLogTime = ref(Date.now()); // é€šçŸ¥é‡è¤‡é˜²æ­¢ç”¨
                let timer = null;

                const addLog = (m) => { const id = Date.now(); logs.value.push({id, message: m}); setTimeout(() => logs.value = logs.value.filter(l => l.id !== id), 3000); };
                const handleLangChange = () => { localStorage.setItem('loto_lang', currentLang.value); wallet.currency = t.value.cur; };

                const initGame = async (m) => {
                    mode.value = m;
                    const name = playerName.value.trim() || 'Player ' + Math.floor(Math.random()*900+100);
                    playerName.value = name; localStorage.setItem('loto_player_name', name);
                    if(m === 'MULTI') {
                        if(!roomId.value) roomId.value = Math.random().toString(36).substring(2, 7).toUpperCase();
                        window.history.pushState({}, '', `?room=${roomId.value}`);
                        const pRef = db.ref(`rooms/${roomId.value}/players`);
                        const s = await pRef.once('value');
                        if(Object.keys(s.val()||{}).length >= 10 && !(s.val()||{})[name.replace(/[.#$[\]]/g, "_")]) return alert(t.value.fullMsg);
                        pRef.child(name.replace(/[.#$[\]]/g, "_")).set(true);
                        // é€ä¿¡æ™‚ã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä»˜ä¸Ž
                        db.ref(`rooms/${roomId.value}`).update({ msg: `${name} joined!`, msgTime: firebase.database.ServerValue.TIMESTAMP });
                    }
                    gameState.value = 'SETUP';
                };

                const startGame = () => {
                    if(wallet.amount < (betAmount.value * ticketCount.value)) return alert("Low balance");
                    wallet.amount -= (betAmount.value * ticketCount.value);
                    myCards.value = Array.from({length: ticketCount.value}, () => generateCard());
                    myMarks.value = myCards.value.map(c => c.map(r => r.map(() => false)));
                    drawnHistory.value = []; currentNumber.value = null; gameState.value = 'PLAYING';
                    
                    if(mode.value === 'SOLO') { 
                        if(isAuto.value) timer = setInterval(() => { if(!isPaused.value) drawNext(); }, drawInterval.value * 1000); 
                    } else {
                        const rRef = db.ref(`rooms/${roomId.value}`);
                        // å‚åŠ æ™‚ç‚¹ã®æ™‚é–“ã‚’è¨˜éŒ²
                        lastLogTime.value = Date.now();
                        
                        rRef.on('value', s => { 
                            const d = s.val(); 
                            if(d){ 
                                if(d.num) currentNumber.value = d.num; 
                                if(d.his) drawnHistory.value = d.his; 
                                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç¢ºèªã—ã€æ–°ã—ã„ã‚‚ã®ã ã‘è¡¨ç¤º
                                if(d.msg && d.msgTime && d.msgTime > lastLogTime.value){ 
                                    addLog(d.msg); 
                                    lastLogTime.value = d.msgTime; 
                                }
                            } 
                        });
                        if(isAuto.value) timer = setInterval(() => { if(!isPaused.value && drawnHistory.value.length < 90) drawNext(); }, drawInterval.value * 1000);
                    }
                };

                const drawNext = () => {
                    if(drawnHistory.value.length >= 90) return clearInterval(timer);
                    let n; do { n = Math.floor(Math.random()*90)+1; } while(drawnHistory.value.includes(n));
                    if(mode.value === 'SOLO') { currentNumber.value = n; drawnHistory.value.push(n); }
                    else db.ref(`rooms/${roomId.value}`).update({ num: n, his: [...drawnHistory.value, n] });
                };

                const checkKinh = () => {
                    const win = myMarks.value.some((card, cIdx) => card.some((row, rIdx) => {
                        const nums = myCards.value[cIdx][rIdx].filter(n => n !== 0);
                        const marks = myCards.value[cIdx][rIdx].filter((n, nIdx) => n !== 0 && row[nIdx]);
                        return nums.length === 5 && marks.length === 5 && marks.every(n => drawnHistory.value.includes(n));
                    }));
                    if(win) { 
                        alert(t.value.winMsg); 
                        wallet.amount += (betAmount.value * 10); 
                        if(mode.value === 'MULTI') db.ref(`rooms/${roomId.value}`).update({ msg: `ðŸŽ‰ ${playerName.value} KINH!`, msgTime: firebase.database.ServerValue.TIMESTAMP }); 
                        confirmQuit(); 
                    } else alert(t.value.loseMsg);
                };

                const confirmQuit = () => { 
                    if(confirm(t.value.quitConfirm)) { 
                        clearInterval(timer); 
                        if(mode.value === 'MULTI') {
                            db.ref(`rooms/${roomId.value}/players/${playerName.value.replace(/[.#$[\]]/g, "_")}`).remove();
                            db.ref(`rooms/${roomId.value}`).off(); // ãƒªã‚¹ãƒŠãƒ¼è§£é™¤
                        }
                        gameState.value = 'HOME'; 
                    } 
                };

                const toggleMark = (cIdx, rIdx, nIdx) => { if (myCards.value[cIdx][rIdx][nIdx] !== 0) myMarks.value[cIdx][rIdx][nIdx] = !myMarks.value[cIdx][rIdx][nIdx]; };
                const isMarked = (cIdx, rIdx, nIdx) => myMarks.value[cIdx]?.[rIdx]?.[nIdx];
                const generateCard = () => {
                    let card = [Array(9).fill(0), Array(9).fill(0), Array(9).fill(0)];
                    const colBounds = [[1,9],[10,19],[20,29],[30,39],[40,49],[50,59],[60,69],[70,79],[80,90]];
                    for(let r=0; r<3; r++){
                        let cols = [0,1,2,3,4,5,6,7,8].sort(()=>Math.random()-0.5).slice(0,5).sort();
                        cols.forEach(c => {
                            let [min, max] = colBounds[c];
                            let n; do { n = Math.floor(Math.random() * (max - min + 1)) + min; } while(card[0][c]===n || card[1][c]===n || card[2][c]===n);
                            card[r][c] = n;
                        });
                    }
                    return card;
                };

                const openWalletModal = () => { tempWallet.amount = wallet.amount; tempWallet.currency = wallet.currency; showWalletModal.value = true; };
                const saveWallet = () => { wallet.amount = tempWallet.amount; wallet.currency = tempWallet.currency; showWalletModal.value = false; };
                const copyLink = () => { navigator.clipboard.writeText(window.location.href); addLog(t.value.copyBtn + " OK!"); };

                watch(showShareModal, (v) => { if(v) setTimeout(() => { document.getElementById('qrcode').innerHTML = ""; new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 180, height: 180 }); }, 100); });
                onMounted(() => { if(roomId.value) initGame('MULTI'); });

                return { currentLang, t, i18n, gameState, mode, playerName, wallet, tempWallet, showWalletModal, showShareModal, ticketCount, betAmount, isAuto, drawInterval, isPaused, myCards, currentNumber, drawnHistory, roomId, logs, handleLangChange, initGame, startGame, drawNext, checkKinh, confirmQuit, toggleMark, isMarked, openWalletModal, saveWallet, copyLink, togglePause: () => isPaused.value = !isPaused.value };
            }
        }).mount('#app');
    </script>
</body>
</html>
