<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LÃ´ TÃ´ Pro - Multi-Language & Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        .cell { transition: all 0.2s; aspect-ratio: 1/1; }
        .marked { background-color: #ef4444; color: white; transform: scale(0.9); border-radius: 50%; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 font-sans">
    <div id="app" v-cloak class="min-h-screen max-w-md mx-auto p-4 flex flex-col">
        
        <div class="flex justify-between items-center mb-4">
            <select v-model="currentLang" class="bg-white border rounded px-2 py-1 text-xs">
                <option value="en">English</option>
                <option value="vi">Tiáº¿ng Viá»‡t</option>
                <option value="fr">FranÃ§ais</option>
                <option value="zh">ç®€ä½“ä¸­æ–‡</option>
            </select>
            <div class="text-right">
                <span class="text-[10px] text-gray-500 block">{{ t.wallet }}</span>
                <span class="font-bold text-green-600">${{ wallet.toLocaleString() }}</span>
            </div>
        </div>

        <div v-if="roomId" class="bg-blue-50 p-3 rounded-lg border border-blue-200 mb-4 flex justify-between items-center">
            <div class="text-xs">
                <p class="font-bold text-blue-800">Room: {{ roomId }}</p>
                <p class="text-blue-600">{{ syncStatus }}</p>
            </div>
            <button @click="copyShareUrl" class="bg-blue-500 text-white text-xs px-3 py-2 rounded hover:bg-blue-600 active:scale-95 transition">
                {{ t.shareUrl }}
            </button>
        </div>

        <div v-if="gameState === 'IDLE'" class="bg-white rounded-2xl shadow-xl p-6 border-t-4 border-red-500">
            <h1 class="text-2xl font-black text-center text-red-600 mb-6 italic">LÃ” TÃ” GLOBAL</h1>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1">{{ t.betLabel }}</label>
                    <input type="number" v-model.number="betAmount" class="w-full p-3 bg-slate-100 rounded-lg text-xl font-bold focus:ring-2 focus:ring-red-500 outline-none">
                </div>

                <div v-if="!roomId">
                    <button @click="initMultiplayer" class="w-full bg-slate-800 text-white py-3 rounded-lg mb-2 font-bold">
                        {{ t.createRoom }}
                    </button>
                </div>

                <button @click="startGame" class="w-full bg-red-600 text-white py-4 rounded-lg text-xl font-bold shadow-lg">
                    {{ t.playNow }}
                </button>
            </div>
        </div>

        <div v-else class="flex-grow flex flex-col items-center">
            <div class="w-32 h-32 bg-white rounded-full border-8 border-red-500 flex items-center justify-center shadow-2xl mb-6 relative">
                <span class="text-5xl font-black text-slate-800">{{ currentNumber || '--' }}</span>
                <div class="absolute -bottom-2 bg-slate-800 text-white text-[10px] px-2 py-1 rounded">
                    {{ drawnHistory.length }} / 90
                </div>
            </div>

            <div v-if="errorMsg" class="w-full bg-red-100 text-red-700 p-2 text-xs rounded mb-4 text-center">
                {{ errorMsg }}
            </div>

            <div class="bg-white p-2 rounded-xl shadow-inner border w-full mb-6">
                <div v-for="(row, rIdx) in playerCard" :key="rIdx" class="grid grid-cols-9 gap-1 mb-1">
                    <div v-for="(num, cIdx) in row" :key="cIdx" 
                         class="cell flex items-center justify-center text-sm font-bold border rounded-sm"
                         :class="[num === 0 ? 'bg-slate-50 border-transparent' : 'bg-white border-slate-200', 
                                  drawnHistory.includes(num) ? 'marked' : '']">
                        {{ num !== 0 ? num : '' }}
                    </div>
                </div>
            </div>

            <div class="w-full space-y-3">
                <button @click="callKinh" class="w-full bg-yellow-400 py-4 rounded-xl font-black text-xl text-yellow-900 shadow-md active:translate-y-1">
                    KINH!
                </button>
                <button @click="resetGame" class="w-full text-slate-400 text-sm py-2">
                    {{ t.back }}
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase è¨­å®š (å„è‡ªã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å…¥ã‚Œã¦ãã ã•ã„) ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            databaseURL: "https://YOUR_PROJECT.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- å¤šè¨€èªžè¾žæ›¸ ---
        const i18n = {
            en: { wallet: "WALLET", betLabel: "BET AMOUNT", playNow: "PLAY NOW", createRoom: "CREATE ROOM", shareUrl: "SHARE URL", back: "Quit Game", win: "YOU WIN!", lose: "LOST!", syncError: "Sync Error. Reconnecting..." },
            vi: { wallet: "VÃ", betLabel: "Má»¨C CÆ¯á»¢C", playNow: "CHÆ I NGAY", createRoom: "Táº O PHÃ’NG", shareUrl: "CHIA Sáºº", back: "ThoÃ¡t", win: "THáº®NG!", lose: "THUA!", syncError: "Lá»—i Ä‘á»“ng bá»™. Äang káº¿t ná»‘i láº¡i..." },
            fr: { wallet: "PORTEFEUILLE", betLabel: "MONTANT MISE", playNow: "JOUER", createRoom: "CRÃ‰ER SALLE", shareUrl: "PARTAGER", back: "Quitter", win: "GAGNÃ‰!", lose: "PERDU!", syncError: "Erreur de synchronisation..." },
            zh: { wallet: "é’±åŒ…", betLabel: "ä¸‹æ³¨é‡‘é¢", playNow: "å¼€å§‹æ¸¸æˆ", createRoom: "åˆ›å»ºæˆ¿é—´", shareUrl: "åˆ†äº«é“¾æŽ¥", back: "é€€å‡º", win: "èŽ·èƒœï¼", lose: "è¾“äº†ï¼", syncError: "åŒæ­¥é”™è¯¯ï¼Œæ­£åœ¨é‡æ–°è¿žæŽ¥..." }
        };

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                const currentLang = ref('en');
                const t = computed(() => i18n[currentLang.value]);
                const wallet = ref(10000);
                const betAmount = ref(100);
                const gameState = ref('IDLE');
                const roomId = ref(new URLSearchParams(window.location.search).get('room'));
                const syncStatus = ref('Stand-alone');
                const errorMsg = ref('');
                
                const currentNumber = ref(null);
                const drawnHistory = ref([]);
                const playerCard = ref([]);

                // --- ã‚«ãƒ¼ãƒ‰ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (æ•´åˆæ€§ã®ãŸã‚ã®ã‚·ãƒ¼ãƒ‰å€¤ç­‰ã¯ä»Šå›žã¯ç°¡æ˜“åŒ–) ---
                const generateCard = () => {
                    let card = [Array(9).fill(0), Array(9).fill(0), Array(9).fill(0)];
                    for(let r=0; r<3; r++) {
                        let cols = [0,1,2,3,4,5,6,7,8].sort(()=>Math.random()-0.5).slice(0,5).sort();
                        cols.forEach(c => {
                            card[r][c] = Math.floor(Math.random() * 10) + (c * 10) + 1;
                        });
                    }
                    return card;
                };

                // --- ãƒžãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒæœŸã‚³ã‚¢æ©Ÿèƒ½ ---
                const initMultiplayer = () => {
                    const newId = Math.random().toString(36).substring(2, 7).toUpperCase();
                    window.location.search = `?room=${newId}`;
                };

                const syncWithFirebase = () => {
                    if (!roomId.value) return;
                    const roomRef = db.ref('rooms/' + roomId.value);
                    
                    // æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯: æŽ¥ç¶šçŠ¶æ…‹ã®ç›£è¦–
                    db.ref('.info/connected').on('value', (snap) => {
                        if (snap.val() === false) {
                            syncStatus.value = "ðŸ”´ Offline";
                            errorMsg.value = t.value.syncError;
                        } else {
                            syncStatus.value = "ðŸŸ¢ Online";
                            errorMsg.value = "";
                        }
                    });

                    // ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­
                    roomRef.on('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            // ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’æ‹…ä¿ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã®å±¥æ­´ã‚’æ­£ã¨ã™ã‚‹ï¼‰
                            currentNumber.value = data.currentNumber;
                            drawnHistory.value = data.history || [];
                            if (data.status === 'WON' && data.winnerId !== 'me') {
                                gameState.value = 'LOST';
                            }
                        }
                    }, (error) => {
                        errorMsg.value = "Access Denied / Room Expired";
                    });
                };

                // --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ---
                const startGame = () => {
                    playerCard.value = generateCard();
                    gameState.value = 'PLAYING';
                    if (!roomId.value) {
                        // ã‚½ãƒ­ãƒ¢ãƒ¼ãƒ‰ï¼š1.5ç§’ã”ã¨ã«è‡ªå‹•æŠ½é¸
                        const timer = setInterval(() => {
                            if (gameState.value !== 'PLAYING' || drawnHistory.value.length >= 90) clearInterval(timer);
                            let next;
                            do { next = Math.floor(Math.random()*90)+1; } while(drawnHistory.value.includes(next));
                            currentNumber.value = next;
                            drawnHistory.value.push(next);
                        }, 2000);
                    }
                };

                const copyShareUrl = () => {
                    navigator.clipboard.writeText(window.location.href);
                    alert("URL Copied!");
                };

                const callKinh = () => {
                    // ã‚µãƒ¼ãƒãƒ¼å´ã®å±¥æ­´(drawnHistory)ã¨ç…§ã‚‰ã—åˆã‚ã›ã¦ã‚¢ã‚¬ãƒªåˆ¤å®š
                    const win = playerCard.value.some(row => {
                        const nums = row.filter(n => n !== 0);
                        return nums.length > 0 && nums.every(n => drawnHistory.value.includes(n));
                    });

                    if (win) {
                        gameState.value = 'WON';
                        wallet.value += betAmount.value * 4;
                        if (roomId.value) {
                            db.ref('rooms/' + roomId.value).update({ status: 'WON', winnerId: 'someone' });
                        }
                        alert(t.value.win);
                    } else {
                        alert("ChÆ°a Ä‘Æ°á»£c! (Not yet)");
                    }
                };

                const resetGame = () => {
                    gameState.value = 'IDLE';
                    drawnHistory.value = [];
                    currentNumber.value = null;
                };

                onMounted(() => {
                    if (roomId.value) syncWithFirebase();
                });

                return {
                    currentLang, t, wallet, betAmount, gameState, roomId, syncStatus,
                    currentNumber, drawnHistory, playerCard, errorMsg,
                    initMultiplayer, startGame, copyShareUrl, callKinh, resetGame
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
