<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOTO ONLINE - Professional Ultimate Build Rev.20260209.3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- Root & Basic Variables --- */
        :root { 
            --primary: #dc2626; 
            --primary-dark: #991b1b;
            --bg-slate: #0f172a;
            --bg-light: #f8fafc;
            --header-height: 75px;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --action-area-height: 120px;
        }

        /* --- Global Reset & Scroll --- */
        [v-cloak] { display: none !important; }

        body { 
            background: var(--bg-slate); 
            font-family: 'Nunito', 'Noto Sans JP', sans-serif; 
            overflow: hidden; 
            margin: 0;
            padding: 0;
            touch-action: manipulation;
            color: #1e293b;
        }

        /* --- Layout Core --- */
        .app-shell {
            height: 100dvh;
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg-light);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 80px rgba(0,0,0,0.5);
            border-left: 1px solid #e2e8f0;
            border-right: 1px solid #e2e8f0;
        }

        /* --- Header: Improved for overlapping prevention --- */
        .app-header {
            height: var(--header-height);
            background: #ffffff;
            border-bottom: 2px solid #f1f5f9;
            display: grid;
            grid-template-columns: 60px 1fr 160px; /* Explicit columns */
            align-items: center;
            padding: 0 15px;
            z-index: 1000;
            flex-shrink: 0;
        }

        .header-title-container {
            text-align: center;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .header-brand {
            font-weight: 900;
            font-size: 1.1rem;
            letter-spacing: -0.05em;
            text-transform: uppercase;
            font-style: italic;
            white-space: nowrap;
        }

        /* --- Wallet UI: Fix for large numbers & overflow --- */
        .wallet-pill {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 999px;
            padding: 5px 12px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-width: 80px;
            max-width: 120px; /* Strict max width */
            transition: all 0.2s ease;
        }

        .wallet-pill:active {
            transform: scale(0.95);
            background: #e2e8f0;
        }

        .wallet-val {
            font-weight: 900;
            font-size: 0.75rem;
            color: #0f172a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Key fix for large numbers */
            margin-left: 6px;
        }

        /* --- Bot Configuration Card --- */
        .bot-setup-card {
            background: white;
            border-radius: 28px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        .bot-slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .bot-btn {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #64748b;
            transition: all 0.2s;
        }

        .bot-btn:active {
            background: #e2e8f0;
            transform: scale(0.9);
        }

        .custom-slider {
            flex-grow: 1;
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            appearance: none;
            outline: none;
        }

        .custom-slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* --- Main Content Areas --- */
        .scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        /* PLAYING SCREEN: Action area height consideration */
        .playing-scroll {
            padding-bottom: var(--action-area-height);
        }

        /* --- Action Area: KINH Button FIXED --- */
        .action-tray {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: var(--action-area-height);
            background: linear-gradient(to top, #ffffff 80%, rgba(255,255,255,0));
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500; /* High priority */
            padding-bottom: calc(20px + var(--safe-bottom));
        }

        .kinh-btn {
            width: 100%;
            height: 75px;
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white;
            border-radius: 24px;
            font-weight: 900;
            font-size: 1.8rem;
            letter-spacing: -0.02em;
            box-shadow: 0 15px 30px -5px rgba(220, 38, 38, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            cursor: pointer;
        }

        .kinh-btn:active {
            transform: scale(0.95);
            box-shadow: 0 5px 10px rgba(220, 38, 38, 0.3);
        }

        /* --- Loto Card Grid --- */
        .loto-card-wrapper {
            background: white;
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }

        .grid-9x3 {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 5px;
        }

        .loto-cell {
            aspect-ratio: 1/1;
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 0.9rem;
            position: relative;
            transition: all 0.2s;
        }

        .loto-cell.has-number {
            background: #ffffff;
            cursor: pointer;
        }

        .loto-cell.marked::after {
            content: '';
            position: absolute;
            width: 80%;
            height: 80%;
            background: rgba(220, 38, 38, 0.85);
            border-radius: 50%;
            z-index: 1;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .loto-cell span { position: relative; z-index: 2; }
        .loto-cell.marked span { color: white; }

        .auto-mode-mask {
            pointer-events: none !important;
            opacity: 0.9;
        }

        /* --- Caller Panel --- */
        .caller-panel {
            background: #0f172a;
            padding: 18px;
            border-bottom: 1px solid #1e293b;
            z-index: 1100;
        }

        .current-num-box {
            width: 85px;
            height: 85px;
            background: white;
            border-radius: 22px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 4px solid var(--primary);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }

        .history-pill {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 0.75rem;
            color: white;
            flex-shrink: 0;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(8px);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-body {
            background: white;
            width: 100%;
            max-width: 380px;
            border-radius: 40px;
            padding: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* --- Utility Classes --- */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .rev-stamp {
            font-size: 8px;
            font-weight: 900;
            color: #94a3b8;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        /* --- Wallet Tools --- */
        .wallet-btn-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .w-tool-btn {
            padding: 12px 0;
            border-radius: 14px;
            font-weight: 900;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .w-tool-btn.plus { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
        .w-tool-btn.minus { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .w-tool-btn:active { transform: scale(0.95); }

    </style>
</head>
<body>

<div id="app" v-cloak class="app-shell">
    
    <header class="app-header">
        <div class="flex items-center">
            <button v-if="gameState !== 'HOME'" @click="handleExitRequest" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400">
                <i class="fas fa-chevron-left text-xl"></i>
            </button>
            <div v-else class="w-9 h-9 bg-red-600 rounded-full flex items-center justify-center text-white font-black text-[10px] shadow-lg">LOTO</div>
        </div>

        <div class="header-title-container">
            <h1 class="header-brand">
                LOTO <span class="text-red-600">ONLINE</span>
            </h1>
            <span class="rev-stamp">REV.20260209-ULT</span>
        </div>

        <div class="flex items-center justify-end gap-2">
            <div @click="showWalletModal = true" class="wallet-pill">
                <i class="fas fa-coins text-yellow-500 text-[10px]"></i>
                <div class="wallet-val">{{ wallet.amount.toLocaleString() }}</div>
            </div>
            <button @click="showSettingsModal = true" class="w-9 h-9 bg-slate-50 border border-slate-200 rounded-full flex items-center justify-center text-slate-400">
                <i class="fas fa-cog text-sm"></i>
            </button>
        </div>
    </header>

    <main class="flex-grow relative flex flex-col overflow-hidden">
        
        <div v-if="gameState === 'HOME'" class="flex-grow flex flex-col items-center justify-center p-8 space-y-10">
            <div class="text-center space-y-4">
                <div class="relative inline-block">
                    <div class="w-28 h-28 bg-red-600 rounded-[35%] rotate-12 absolute inset-0 opacity-10 animate-pulse"></div>
                    <div class="w-28 h-28 bg-white rounded-3xl flex items-center justify-center text-5xl font-black text-slate-900 shadow-2xl relative border-2 border-slate-100">
                        90
                    </div>
                </div>
                <div>
                    <h2 class="text-3xl font-black text-slate-800 tracking-tighter uppercase italic">{{ t.welcomeTitle }}</h2>
                    <p class="text-slate-400 font-bold text-[10px] tracking-[0.3em] mt-2 uppercase">Professional Gaming Experience</p>
                </div>
            </div>

            <div class="w-full space-y-4 max-w-xs">
                <div class="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm">
                    <label class="text-[10px] font-black text-slate-400 uppercase block mb-2">{{ t.playerNameLabel }}</label>
                    <input v-model="playerName" class="w-full text-center font-black text-2xl text-slate-800 outline-none" :placeholder="t.placeholderName">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button @click="navToSetup('SOLO')" class="h-36 bg-white rounded-[40px] shadow-lg border-b-4 border-slate-200 flex flex-col items-center justify-center group active:translate-y-1 active:border-b-0 transition-all">
                        <i class="fas fa-user text-3xl text-slate-200 group-hover:text-red-500 mb-3 transition-colors"></i>
                        <span class="font-black text-[11px] uppercase text-slate-500">{{ t.modeSolo }}</span>
                    </button>
                    <button @click="navToSetup('MULTI')" class="h-36 bg-red-600 rounded-[40px] shadow-xl shadow-red-200 flex flex-col items-center justify-center group active:scale-95 transition-all">
                        <i class="fas fa-users text-3xl text-white/40 group-hover:text-white mb-3 transition-colors"></i>
                        <span class="font-black text-[11px] uppercase text-white">{{ t.modeMulti }}</span>
                    </button>
                </div>
            </div>

            <footer class="text-center">
                <p class="rev-stamp">{{ currentTime }}</p>
            </footer>
        </div>

        <div v-if="gameState === 'SETUP'" class="scroll-area space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-black text-slate-800">{{ t.setupTitle }}</h3>
                <span class="bg-red-50 text-red-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">{{ mode }}</span>
            </div>

            <div class="bot-setup-card">
                <div class="flex justify-between items-center">
                    <label class="text-[10px] font-black text-slate-400 uppercase">{{ t.opponentsLabel }}</label>
                    <span class="text-2xl font-black text-red-600">{{ botCount }}</span>
                </div>
                <div class="bot-slider-container">
                    <button @click="botCount = Math.max(0, botCount - 1)" class="bot-btn"><i class="fas fa-minus"></i></button>
                    <input type="range" v-model.number="botCount" min="0" max="10" class="custom-slider">
                    <button @click="botCount = Math.min(10, botCount + 1)" class="bot-btn"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-[32px] border border-slate-200">
                <label class="text-[10px] font-black text-slate-400 uppercase block mb-4">{{ t.ticketQtyLabel }}</label>
                <div class="grid grid-cols-4 gap-3">
                    <button v-for="n in 4" :key="n" @click="ticketQty = n" 
                        :class="ticketQty === n ? 'bg-red-600 text-white shadow-lg' : 'bg-slate-50 text-slate-400'"
                        class="h-14 rounded-2xl font-black text-lg transition-all">
                        {{ n }}
                    </button>
                </div>
            </div>

            <div class="bg-slate-900 p-8 rounded-[40px] text-white shadow-2xl relative overflow-hidden">
                <div class="relative z-10">
                    <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">{{ t.betLabel }}</label>
                    <div class="flex items-center">
                        <span class="text-3xl font-black text-slate-600 mr-3">$</span>
                        <input type="number" v-model.number="betAmount" class="bg-transparent text-5xl font-black outline-none w-full">
                    </div>
                </div>
                <i class="fas fa-wallet absolute -right-6 -bottom-6 text-9xl text-white/5 rotate-12"></i>
            </div>

            <button @click="startGame" class="w-full h-20 bg-red-600 text-white rounded-[28px] font-black text-2xl shadow-2xl shadow-red-200 active:scale-95 transition-transform flex items-center justify-center gap-3">
                <span>{{ t.startBtn }}</span>
                <i class="fas fa-play"></i>
            </button>
            
            <div class="h-10"></div>
        </div>

        <div v-if="gameState === 'PLAYING'" class="flex-grow flex flex-col h-full bg-slate-50">
            <div class="caller-panel">
                <div class="flex gap-5 items-center">
                    <div class="current-num-box">
                        <span class="text-[9px] font-black text-slate-400 uppercase leading-none mb-1">Number</span>
                        <span class="text-4xl font-black text-slate-900">{{ currentNumber || '--' }}</span>
                    </div>
                    
                    <div class="flex-grow">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">{{ t.historyLabel }} ({{ drawnNumbers.length }}/90)</span>
                            <div v-if="isAutoMode" class="flex items-center gap-1.5 bg-red-950/50 px-2 py-0.5 rounded-full border border-red-900/50">
                                <div class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div>
                                <span class="text-[9px] font-black text-red-500">AUTO</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2 pt-1">
                            <div v-if="drawnNumbers.length === 0" class="text-slate-600 text-[10px] italic py-3">Waiting for first draw...</div>
                            <div v-for="(num, idx) in [...drawnNumbers].reverse().slice(0, 15)" :key="idx" 
                                :class="idx === 0 ? 'bg-red-600 scale-110 shadow-lg' : 'bg-slate-800 border border-slate-700'"
                                class="history-pill transition-all">
                                {{ num }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex items-center gap-4 bg-slate-800/40 p-3 rounded-2xl border border-white/5">
                    <i class="fas fa-bolt text-yellow-500 text-xs"></i>
                    <input type="range" v-model.number="drawInterval" min="1" max="10" step="1" class="custom-slider" style="height: 4px;">
                    <div class="w-12 text-right">
                        <span class="text-white font-black text-xs">{{ drawInterval }}</span>
                        <span class="text-[8px] font-bold text-slate-500 ml-0.5">SEC</span>
                    </div>
                </div>
            </div>

            <div class="scroll-area playing-scroll">
                <div v-for="(card, cardIdx) in myCards" :key="cardIdx" class="loto-card-wrapper">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">TICKET #00{{ cardIdx + 1 }}</span>
                        <div v-if="isReadyToWin(cardIdx)" class="flex items-center gap-1 text-green-600 font-black text-[10px] animate-bounce">
                            <i class="fas fa-check-circle"></i> READY
                        </div>
                    </div>

                    <div class="grid-9x3" :class="{'auto-mode-mask': isAutoMode}">
                        <template v-for="(row, rowIdx) in card" :key="rowIdx">
                            <div v-for="(cell, cellIdx) in row" :key="cellIdx"
                                @click="toggleMark(cardIdx, rowIdx, cellIdx)"
                                :class="[
                                    cell === 0 ? 'opacity-0' : 'loto-cell has-number',
                                    isMarked(cardIdx, rowIdx, cellIdx) ? 'marked' : ''
                                ]">
                                <span>{{ cell !== 0 ? cell : '' }}</span>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="h-20"></div>
            </div>

            <div class="action-tray">
                <div class="flex gap-3 w-full">
                    <button @click="callBingo" class="kinh-btn">
                        {{ t.kinhBtn }}
                    </button>
                    <button v-if="!isAutoMode" @click="drawNextNumber" class="w-24 h-[75px] bg-slate-900 text-white rounded-3xl flex items-center justify-center shadow-xl">
                        <i class="fas fa-forward text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div v-if="showWalletModal" class="modal-overlay">
        <div class="modal-body text-center">
            <h3 class="font-black text-2xl text-slate-800 mb-8">{{ t.walletTitle }}</h3>
            
            <div class="bg-slate-50 p-8 rounded-[40px] border border-slate-100 mb-6">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Available Funds</span>
                <input type="number" v-model.number="wallet.amount" class="text-5xl font-black text-slate-900 w-full text-center bg-transparent outline-none">
            </div>

            <div class="space-y-3 mb-10">
                <div class="wallet-btn-grid">
                    <button @click="wallet.amount += 100" class="w-tool-btn plus">+100</button>
                    <button @click="wallet.amount += 1000" class="w-tool-btn plus">+1,000</button>
                    <button @click="wallet.amount += 10000" class="w-tool-btn plus">+10,000</button>
                </div>
                <div class="wallet-btn-grid">
                    <button @click="wallet.amount = Math.max(0, wallet.amount - 100)" class="w-tool-btn minus">-100</button>
                    <button @click="wallet.amount = Math.max(0, wallet.amount - 1000)" class="w-tool-btn minus">-1,000</button>
                    <button @click="wallet.amount = Math.max(0, wallet.amount - 10000)" class="w-tool-btn minus">-10,000</button>
                </div>
            </div>

            <button @click="showWalletModal = false" class="w-full h-16 bg-slate-900 text-white rounded-3xl font-black text-sm tracking-widest shadow-xl">
                DONE
            </button>
        </div>
    </div>

    <div v-if="showSettingsModal" class="modal-overlay">
        <div class="modal-body max-h-[85vh] overflow-y-auto no-scrollbar">
            <div class="flex justify-between items-center mb-8">
                <h3 class="font-black text-2xl text-slate-800">{{ t.settingsTitle }}</h3>
                <button @click="showSettingsModal = false" class="text-slate-300"><i class="fas fa-times text-xl"></i></button>
            </div>

            <div class="space-y-8">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-4">Localization</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button v-for="(lang, key) in languages" :key="key" @click="setLanguage(key)"
                            :class="currentLang === key ? 'border-red-600 bg-red-50 text-red-700' : 'border-slate-100 bg-slate-50 text-slate-500'"
                            class="p-4 border-2 rounded-2xl font-black text-xs transition-all">
                            {{ lang.label }}
                        </button>
                    </div>
                </div>

                <div class="flex items-center justify-between bg-slate-50 p-6 rounded-3xl border border-slate-100">
                    <div>
                        <span class="block font-black text-slate-800 text-sm">Auto-Mark Mode</span>
                        <span class="text-[9px] font-bold text-slate-400 uppercase">Recommended for pros</span>
                    </div>
                    <button @click="isAutoMode = !isAutoMode" 
                        :class="isAutoMode ? 'bg-green-500' : 'bg-slate-300'"
                        class="w-16 h-9 rounded-full relative transition-all duration-300">
                        <div :class="isAutoMode ? 'translate-x-8' : 'translate-x-1'" class="absolute top-1 w-7 h-7 bg-white rounded-full shadow-md transition-transform duration-300"></div>
                    </button>
                </div>
            </div>

            <button @click="showSettingsModal = false" class="w-full mt-10 h-16 bg-slate-900 text-white rounded-3xl font-black uppercase text-xs tracking-widest">
                Save & Close
            </button>
        </div>
    </div>

</div>

<script>
/**
 * --- INTERNATIONALIZATION DATA (8 Languages, Full Definition) ---
 * VERBOSE DEFINITION TO ENSURE SCALE AND ACCURACY
 */
const i18nData = {
    ja: {
        label: "日本語",
        welcomeTitle: "ロト・オンライン",
        playerNameLabel: "プレイヤー名",
        placeholderName: "名前を入力...",
        modeSolo: "一人で遊ぶ",
        modeMulti: "みんなで遊ぶ",
        setupTitle: "ゲーム設定",
        ticketQtyLabel: "購入チケット枚数",
        opponentsLabel: "対戦相手 (BOT)",
        betLabel: "ベット金額",
        startBtn: "ゲームを開始する",
        kinhBtn: "ビンゴ！ (KINH)",
        winMsg: "おめでとうございます！ビンゴ達成です！",
        loseMsg: "まだ番号が揃っていないようです。",
        settingsTitle: "環境設定",
        walletTitle: "ウォレット管理",
        historyLabel: "直近の当選番号",
        confirmExit: "現在のゲームを終了してホームに戻りますか？"
    },
    vi: {
        label: "Tiếng Việt",
        welcomeTitle: "LOTO ONLINE",
        playerNameLabel: "TÊN NGƯỜI CHƠI",
        placeholderName: "Nhập tên của bạn...",
        modeSolo: "CHƠI ĐƠN",
        modeMulti: "CHƠI NHIỀU NGƯỜI",
        setupTitle: "THIẾT LẬP GAME",
        ticketQtyLabel: "SỐ LƯỢNG VÉ",
        opponentsLabel: "ĐỐI THỦ (BOT)",
        betLabel: "MỨC TIỀN CƯỢC",
        startBtn: "BẮT ĐẦU CHƠI",
        kinhBtn: "KINH!",
        winMsg: "Chúc mừng! Bạn đã giành chiến thắng!",
        loseMsg: "Chưa đủ số để Kinh, hãy kiểm tra lại!",
        settingsTitle: "CÀI ĐẶT",
        walletTitle: "VÍ CỦA BẠN",
        historyLabel: "LỊCH SỬ KÉO SỐ",
        confirmExit: "Bạn có thực sự muốn thoát game không?"
    },
    en: {
        label: "English",
        welcomeTitle: "LOTO ONLINE",
        playerNameLabel: "PLAYER NAME",
        placeholderName: "Your name...",
        modeSolo: "SOLO PLAY",
        modeMulti: "MULTIPLAYER",
        setupTitle: "GAME SETUP",
        ticketQtyLabel: "TICKET QUANTITY",
        opponentsLabel: "BOT OPPONENTS",
        betLabel: "BET AMOUNT",
        startBtn: "START GAME",
        kinhBtn: "BINGO!",
        winMsg: "Congratulations! You won the game!",
        loseMsg: "Not enough numbers for Bingo yet.",
        settingsTitle: "SETTINGS",
        walletTitle: "WALLET",
        historyLabel: "DRAW HISTORY",
        confirmExit: "Are you sure you want to quit the game?"
    },
    cn: {
        label: "简体中文",
        welcomeTitle: "在线乐透",
        playerNameLabel: "玩家姓名",
        placeholderName: "输入名字...",
        modeSolo: "单人模式",
        modeMulti: "多人对战",
        setupTitle: "游戏设置",
        ticketQtyLabel: "购买票数",
        opponentsLabel: "机器人数量",
        betLabel: "下注金额",
        startBtn: "开始游戏",
        kinhBtn: "胡了!",
        winMsg: "恭喜你！你赢了！",
        loseMsg: "号码还没凑齐，再接再厉！",
        settingsTitle: "设置",
        walletTitle: "钱包",
        historyLabel: "历史开奖",
        confirmExit: "确定要退出当前游戏吗？"
    },
    th: {
        label: "ไทย",
        welcomeTitle: "โลโต้ ออนไลน์",
        playerNameLabel: "ชื่อผู้เล่น",
        placeholderName: "กรอกชื่อ...",
        modeSolo: "เล่นคนเดียว",
        modeMulti: "เล่นหลายคน",
        setupTitle: "ตั้งค่าเกม",
        ticketQtyLabel: "จำนวนตั๋ว",
        opponentsLabel: "คู่แข่ง (BOT)",
        betLabel: "จำนวนเงินเดิมพัน",
        startBtn: "เริ่มเกม",
        kinhBtn: "บิงโก!",
        winMsg: "ยินดีด้วย! คุณเป็นผู้ชนะ!",
        loseMsg: "ยังไม่บิงโก ลองเช็คอีกครั้ง!",
        settingsTitle: "การตั้งค่า",
        walletTitle: "กระเป๋าเงิน",
        historyLabel: "ประวัติการออกรางวัล",
        confirmExit: "คุณต้องการออกจากเกมใช่หรือไม่?"
    },
    lo: {
        label: "ລາວ",
        welcomeTitle: "ໂລໂຕ ອອນລາຍ",
        playerNameLabel: "ຊື່ຜູ້ຫຼິ້ນ",
        placeholderName: "ປ້ອນຊື່...",
        modeSolo: "ຫຼິ້ນດ່ຽວ",
        modeMulti: "ຫຼິ້ນຫຼາຍຄົນ",
        setupTitle: "ຕັ້ງຄ່າເກມ",
        ticketQtyLabel: "ຈຳນວນໃບ",
        opponentsLabel: "ຄູ່ແຂ່ງ (BOT)",
        betLabel: "ເງິນເດີມພັນ",
        startBtn: "ເລີ່ມເກມ",
        kinhBtn: "ຊະນະ!",
        winMsg: "ຂໍສະແດງຄວາມຍິນດີ! ທ່ານຊະນະແລ້ວ!",
        loseMsg: "ຕົວເລກຍັງບໍ່ທັນຄົບ!",
        settingsTitle: "ການຕັ້ງຄ່າ",
        walletTitle: "ກະເປົາເງິນ",
        historyLabel: "ປະຫວັດການອອກເລກ",
        confirmExit: "ທ່ານຕ້ອງການອອກຈາກເກມບໍ່?"
    },
    km: {
        label: "ភាសាខ្មែរ",
        welcomeTitle: "ឡូតូ អនឡាញ",
        playerNameLabel: "ឈ្មោះអ្នកលេង",
        placeholderName: "បញ្ចូលឈ្មោះ...",
        modeSolo: "លេងម្នាក់ឯង",
        modeMulti: "លេងច្រើននាក់",
        setupTitle: "ការកំណត់",
        ticketQtyLabel: "ចំនួនសន្លឹក",
        opponentsLabel: "គូប្រកួត (BOT)",
        betLabel: "ប្រាក់ភ្នាល់",
        startBtn: "ចាប់ផ្ដើម",
        kinhBtn: "ឈ្នះ!",
        winMsg: "អបអរសាទរ! អ្នកបានឈ្នះ!",
        loseMsg: "មិនទាន់គ្រប់លេខទេ!",
        settingsTitle: "ការកំណត់",
        walletTitle: "កាបូបប្រាក់",
        historyLabel: "ប្រវត្តិចេញលេខ",
        confirmExit: "តើអ្នកចង់ចាកចេញពីហ្គេមមែនទេ?"
    },
    fr: {
        label: "Français",
        welcomeTitle: "LOTO EN LIGNE",
        playerNameLabel: "NOM DU JOUEUR",
        placeholderName: "Entrez votre nom...",
        modeSolo: "SOLO",
        modeMulti: "MULTIJOUEUR",
        setupTitle: "CONFIGURATION",
        ticketQtyLabel: "QUANTITÉ BILLETS",
        opponentsLabel: "ADVERSAIRES BOTS",
        betLabel: "MONTANT DE MISE",
        startBtn: "COMMENCER",
        kinhBtn: "BINGO!",
        winMsg: "Félicitations ! Vous avez gagné !",
        loseMsg: "Pas encore de Bingo, continuez !",
        settingsTitle: "RÉGLAGES",
        walletTitle: "PORTEFEUILLE",
        historyLabel: "HISTORIQUE",
        confirmExit: "Voulez-vous vraiment quitter ?"
    }
};

/**
 * --- VUE APPLICATION LOGIC ---
 */
const { createApp, ref, reactive, computed, watch, onMounted, onUnmounted } = Vue;

createApp({
    setup() {
        // --- State ---
        const currentLang = ref(localStorage.getItem('app_lang_v3') || 'ja');
        const gameState = ref('HOME'); 
        const mode = ref('SOLO');
        const playerName = ref(localStorage.getItem('app_user_name') || '');
        const wallet = reactive({ amount: 10000 });
        
        const ticketQty = ref(1);
        const botCount = ref(3);
        const betAmount = ref(100);
        const isAutoMode = ref(true);
        const drawInterval = ref(3); // In seconds
        
        const myCards = ref([]);
        const myMarks = ref([]); 
        const drawnNumbers = ref([]);
        const currentNumber = ref(null);
        
        const showSettingsModal = ref(false);
        const showWalletModal = ref(false);
        const currentTime = ref('');
        
        let gameTimer = null;
        let clockTimer = null;

        // --- Computed ---
        const t = computed(() => i18nData[currentLang.value]);
        const languages = computed(() => i18nData);

        // --- Lifecycle ---
        onMounted(() => {
            updateClock();
            clockTimer = setInterval(updateClock, 1000);
        });

        onUnmounted(() => {
            stopGameTimer();
            if(clockTimer) clearInterval(clockTimer);
        });

        // --- Core Methods ---
        const updateClock = () => {
            const now = new Date();
            currentTime.value = now.toLocaleString();
        };

        const setLanguage = (key) => {
            currentLang.value = key;
            localStorage.setItem('app_lang_v3', key);
        };

        const navToSetup = (selectedMode) => {
            mode.value = selectedMode;
            if(!playerName.value) {
                playerName.value = "Player_" + Math.floor(Math.random() * 9000 + 1000);
            }
            localStorage.setItem('app_user_name', playerName.value);
            gameState.value = 'SETUP';
        };

        const startGame = () => {
            const totalBet = betAmount.value * ticketQty.value;
            if (wallet.amount < totalBet) {
                alert("Insufficient wallet balance!");
                return;
            }

            wallet.amount -= totalBet;
            generateTickets();
            
            drawnNumbers.value = [];
            currentNumber.value = null;
            gameState.value = 'PLAYING';
            
            if (isAutoMode.value) {
                startGameTimer();
            }
        };

        const generateTickets = () => {
            const newCards = [];
            const newMarks = [];

            for (let i = 0; i < ticketQty.value; i++) {
                // Loto 90 Style: 3 rows, 9 columns. Each row has exactly 5 numbers.
                const card = Array(3).fill(0).map(() => Array(9).fill(0));
                const marks = Array(3).fill(0).map(() => Array(9).fill(false));
                
                const colRanges = [
                    [1, 9], [10, 19], [20, 29], [30, 39], [40, 49], 
                    [50, 59], [60, 69], [70, 79], [80, 90]
                ];

                for (let r = 0; r < 3; r++) {
                    // Select 5 random columns for this row
                    const targetCols = [0, 1, 2, 3, 4, 5, 6, 7, 8]
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 5)
                        .sort();

                    targetCols.forEach(c => {
                        let num;
                        let isUnique = false;
                        while(!isUnique) {
                            num = Math.floor(Math.random() * (colRanges[c][1] - colRanges[c][0] + 1)) + colRanges[c][0];
                            // Check uniqueness in the same column across rows
                            isUnique = !card.some(row => row[c] === num);
                        }
                        card[r][c] = num;
                    });
                }
                newCards.push(card);
                newMarks.push(marks);
            }
            myCards.value = newCards;
            myMarks.value = newMarks;
        };

        const startGameTimer = () => {
            stopGameTimer();
            gameTimer = setInterval(() => {
                drawNextNumber();
            }, drawInterval.value * 1000);
        };

        const stopGameTimer = () => {
            if (gameTimer) {
                clearInterval(gameTimer);
                gameTimer = null;
            }
        };

        // Watch for speed changes during play
        watch(drawInterval, () => {
            if (gameState.value === 'PLAYING' && isAutoMode.value) {
                startGameTimer();
            }
        });

        const drawNextNumber = () => {
            if (drawnNumbers.value.length >= 90) {
                stopGameTimer();
                return;
            }

            let next;
            do {
                next = Math.floor(Math.random() * 90) + 1;
            } while (drawnNumbers.value.includes(next));

            currentNumber.value = next;
            drawnNumbers.value.push(next);

            // If auto mode is on, automatically mark matching numbers
            if (isAutoMode.value) {
                performAutoMark(next);
            }

            // --- SYNC LOGIC PLACEHOLDER ---
            // If multiplayer (Firebase), we would update the DB here.
            // if(mode.value === 'MULTI') syncWithFirebase(next);
        };

        const performAutoMark = (num) => {
            myCards.value.forEach((card, ci) => {
                card.forEach((row, ri) => {
                    row.forEach((cell, ni) => {
                        if (cell === num) {
                            myMarks.value[ci][ri][ni] = true;
                        }
                    });
                });
            });
        };

        const toggleMark = (ci, ri, ni) => {
            // In auto-mode, manual marking is disabled to prevent cheating/interference
            if (isAutoMode.value) return;

            const val = myCards.value[ci][ri][ni];
            if (val === 0) return;

            // Only allow marking if the number has been drawn
            if (drawnNumbers.value.includes(val)) {
                myMarks.value[ci][ri][ni] = !myMarks.value[ci][ri][ni];
            }
        };

        const isMarked = (ci, ri, ni) => myMarks.value[ci][ri][ni];

        const isReadyToWin = (ci) => {
            // Winning condition: Any full row (5 numbers) marked
            return myMarks.value[ci].some(row => row.filter(m => m).length === 5);
        };

        const callBingo = () => {
            let winDetected = false;
            
            myCards.value.forEach((card, ci) => {
                card.forEach((row, ri) => {
                    const correctlyMarked = row.filter((cell, ni) => {
                        return cell !== 0 && myMarks.value[ci][ri][ni] && drawnNumbers.value.includes(cell);
                    }).length;

                    if (correctlyMarked === 5) {
                        winDetected = true;
                    }
                });
            });

            if (winDetected) {
                alert(t.value.winMsg);
                // Reward: 12x the bet
                wallet.amount += betAmount.value * 12;
                resetToHome();
            } else {
                alert(t.value.loseMsg);
            }
        };

        const handleExitRequest = () => {
            if (confirm(t.value.confirmExit)) {
                resetToHome();
            }
        };

        const resetToHome = () => {
            stopGameTimer();
            gameState.value = 'HOME';
        };

        return {
            // Refs
            currentLang, gameState, mode, playerName, wallet,
            ticketQty, botCount, betAmount, isAutoMode, drawInterval,
            myCards, myMarks, drawnNumbers, currentNumber,
            showSettingsModal, showWalletModal, currentTime,
            // Computed
            t, languages,
            // Methods
            setLanguage, navToSetup, startGame, drawNextNumber, toggleMark,
            isMarked, isReadyToWin, callBingo, handleExitRequest
        };
    }
}).mount('#app');

/**
 * FIREBASE / MULTIPLAYER STUB
 * Detailed logic for room synchronization
 */
function syncWithFirebase(num) {
    // This is where real-time database logic would integrate.
    // Example: firebase.database().ref('rooms/' + roomId).update({ lastNum: num });
    console.log("Multilayer Sync: " + num);
}

/**
 * BOT LOGIC STUB
 * Detailed simulation for bot opponents
 */
function simulateBots(count) {
    for(let i=0; i<count; i++) {
        // Each bot would have its own hidden card and logic to mark.
        // If a bot wins, the game should trigger a "Bot Won" state.
    }
}
</script>
</body>
</html>
