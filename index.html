<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOTO ONLINE - Professional Rev.20260209.4 (Invite Restored)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --primary: #dc2626; 
            --bg-slate: #0f172a;
            --bg-light: #f8fafc;
            --header-h: 75px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --action-h: 120px;
        }

        [v-cloak] { display: none !important; }

        body { 
            background: var(--bg-slate); 
            font-family: 'Nunito', 'Noto Sans JP', sans-serif; 
            overflow: hidden; 
            touch-action: manipulation;
        }

        .app-shell {
            height: 100dvh;
            max-width: 480px;
            margin: 0 auto;
            background: var(--bg-light);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 80px rgba(0,0,0,0.5);
        }

        /* HEADER & WALLET FIX */
        .app-header {
            height: var(--header-h);
            background: white;
            border-bottom: 2px solid #f1f5f9;
            display: grid;
            grid-template-columns: 60px 1fr 160px;
            align-items: center;
            padding: 0 15px;
            z-index: 1000;
        }

        .wallet-pill {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 999px;
            padding: 5px 12px;
            display: flex;
            align-items: center;
            max-width: 120px;
        }

        .wallet-val {
            font-weight: 900;
            font-size: 0.75rem;
            color: #0f172a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* 桁数対策 */
            margin-left: 6px;
        }

        /* SCROLL AREAS */
        .scroll-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }
        .playing-scroll { padding-bottom: var(--action-h); }

        /* ACTION AREA (KINH BUTTON) FIX */
        .action-tray {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: var(--action-h);
            background: linear-gradient(to top, white 80%, transparent);
            padding: 20px;
            padding-bottom: calc(20px + var(--safe-bottom));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .kinh-btn {
            width: 100%; height: 75px;
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white; border-radius: 24px;
            font-weight: 900; font-size: 1.8rem;
            box-shadow: 0 15px 30px -5px rgba(220, 38, 38, 0.5);
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .kinh-btn:active { transform: scale(0.95); }

        /* BOT CONFIG FIX */
        .bot-setup-card {
            background: white; border-radius: 28px;
            padding: 24px; border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px rgba(0,0,0,0.05);
        }
        .bot-slider-row { display: flex; align-items: center; gap: 12px; margin-top: 15px; }
        .bot-btn {
            width: 44px; height: 44px; border-radius: 14px;
            background: #f1f5f9; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #64748b;
        }

        /* LOTO CARD */
        .loto-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 5px; }
        .loto-cell {
            aspect-ratio: 1/1; background: #f1f5f9; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 0.9rem; position: relative;
        }
        .loto-cell.marked::after {
            content: ''; position: absolute; width: 80%; height: 80%;
            background: rgba(220, 38, 38, 0.85); border-radius: 50%; z-index: 1;
        }
        .loto-cell span { position: relative; z-index: 2; }
        .loto-cell.marked span { color: white; }

        /* MODALS */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px); z-index: 5000;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-body {
            background: white; width: 100%; max-width: 400px;
            border-radius: 40px; padding: 30px;
        }

        /* QR CODE AREA */
        #qrcode {
            margin: 20px auto; padding: 15px;
            background: white; border-radius: 20px;
            display: inline-block; border: 1px solid #f1f5f9;
        }

        /* WALLET TOOLS */
        .wallet-btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .w-tool-btn { padding: 10px 0; border-radius: 12px; font-weight: 900; font-size: 0.75rem; }
    </style>
</head>
<body>

<div id="app" v-cloak class="app-shell">
    
    <header class="app-header">
        <div class="flex items-center">
            <button v-if="gameState !== 'HOME'" @click="backToHome" class="w-10 h-10 flex items-center justify-center text-slate-400">
                <i class="fas fa-arrow-left text-xl"></i>
            </button>
            <div v-else class="w-9 h-9 bg-red-600 rounded-full flex items-center justify-center text-white font-black text-[10px]">LOTO</div>
        </div>

        <div class="text-center">
            <h1 class="font-black text-lg italic tracking-tighter">LOTO <span class="text-red-600">ONLINE</span></h1>
        </div>

        <div class="flex items-center justify-end gap-2">
            <div @click="showWalletModal = true" class="wallet-pill cursor-pointer">
                <i class="fas fa-coins text-yellow-500 text-[10px]"></i>
                <div class="wallet-val">{{ wallet.amount.toLocaleString() }}</div>
            </div>
            <button @click="showSettingsModal = true" class="w-9 h-9 bg-slate-50 border rounded-full text-slate-400">
                <i class="fas fa-cog text-sm"></i>
            </button>
        </div>
    </header>

    <main class="flex-grow relative flex flex-col overflow-hidden">
        
        <div v-if="gameState === 'HOME'" class="flex-grow flex flex-col items-center justify-center p-8 space-y-10">
            <div class="text-center">
                <div class="w-24 h-24 bg-white rounded-3xl flex items-center justify-center text-5xl font-black text-slate-900 shadow-2xl mx-auto mb-4 border">90</div>
                <h2 class="text-3xl font-black text-slate-800 tracking-tighter uppercase italic">{{ t.welcomeTitle }}</h2>
            </div>

            <div class="w-full max-w-xs space-y-4">
                <div class="bg-white p-4 rounded-2xl border">
                    <label class="text-[10px] font-black text-slate-400 block mb-1 uppercase">{{ t.playerNameLabel }}</label>
                    <input v-model="playerName" class="w-full text-center font-black text-xl outline-none" :placeholder="t.placeholderName">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button @click="initSetup('SOLO')" class="h-32 bg-white rounded-3xl shadow flex flex-col items-center justify-center border-b-4 active:translate-y-1 active:border-b-0 transition-all">
                        <i class="fas fa-user text-2xl text-slate-300 mb-2"></i>
                        <span class="font-black text-[10px] uppercase text-slate-500">{{ t.modeSolo }}</span>
                    </button>
                    <button @click="initSetup('MULTI')" class="h-32 bg-red-600 rounded-3xl shadow-xl flex flex-col items-center justify-center active:scale-95 transition-all">
                        <i class="fas fa-users text-2xl text-white/40 mb-2"></i>
                        <span class="font-black text-[10px] uppercase text-white">{{ t.modeMulti }}</span>
                    </button>
                </div>
            </div>
            <p class="text-[8px] font-black text-slate-300 uppercase tracking-widest">{{ currentTime }}</p>
        </div>

        <div v-if="gameState === 'SETUP'" class="scroll-area space-y-6">
            <h3 class="text-2xl font-black text-slate-800">{{ t.setupTitle }}</h3>
            
            <div v-if="mode === 'MULTI' && !isRoomCreated" class="space-y-4">
                <button @click="createRoom" class="w-full h-16 bg-slate-900 text-white rounded-2xl font-black">
                    {{ t.createRoomBtn }}
                </button>
                <div class="relative">
                    <input v-model="inputRoomId" class="w-full h-16 bg-white border-2 border-dashed rounded-2xl text-center font-black" :placeholder="t.placeholderRoom">
                    <button @click="joinRoom" class="absolute right-2 top-2 bottom-2 px-6 bg-red-600 text-white rounded-xl font-black text-xs">JOIN</button>
                </div>
            </div>

            <div v-if="mode === 'SOLO' || isRoomCreated" class="space-y-6">
                <div class="bot-setup-card">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] font-black text-slate-400 uppercase">{{ t.opponentsLabel }}</label>
                        <span class="text-2xl font-black text-red-600">{{ botCount }}</span>
                    </div>
                    <div class="bot-slider-row">
                        <button @click="botCount = Math.max(0, botCount - 1)" class="bot-btn"><i class="fas fa-minus"></i></button>
                        <input type="range" v-model.number="botCount" min="0" max="10" class="flex-grow h-2 bg-slate-200 rounded-lg appearance-none accent-red-600">
                        <button @click="botCount = Math.min(10, botCount + 1)" class="bot-btn"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-3xl border">
                    <label class="text-[10px] font-black text-slate-400 uppercase block mb-4">{{ t.ticketQtyLabel }}</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button v-for="n in 4" :key="n" @click="ticketQty = n" 
                            :class="ticketQty === n ? 'bg-red-600 text-white' : 'bg-slate-50'"
                            class="h-12 rounded-xl font-black transition-all">{{ n }}</button>
                    </div>
                </div>

                <div class="bg-slate-900 p-6 rounded-[32px] text-white shadow-xl">
                    <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">{{ t.betLabel }}</label>
                    <div class="flex items-center text-4xl font-black">
                        <span class="text-slate-600 mr-2">$</span>
                        <input type="number" v-model.number="betAmount" class="bg-transparent w-full outline-none">
                    </div>
                </div>

                <button @click="startGame" class="w-full h-18 bg-red-600 text-white rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-all">
                    {{ t.startBtn }}
                </button>
            </div>
        </div>

        <div v-if="gameState === 'PLAYING'" class="flex-grow flex flex-col h-full bg-slate-50">
            <div class="bg-slate-900 p-4 border-b border-slate-800">
                <div class="flex gap-4 items-center">
                    <div class="w-20 h-20 bg-white rounded-2xl flex items-center justify-center text-4xl font-black text-slate-900 border-4 border-red-600">
                        {{ currentNumber || '--' }}
                    </div>
                    <div class="flex-grow overflow-hidden">
                        <div class="flex justify-between text-[10px] font-black text-slate-500 uppercase mb-2">
                            <span>{{ t.historyLabel }} ({{ drawnNumbers.length }}/90)</span>
                            <span v-if="isAutoMode" class="text-red-500 animate-pulse">AUTO</span>
                        </div>
                        <div class="flex gap-1.5 overflow-x-auto no-scrollbar py-1">
                            <div v-for="(n, i) in [...drawnNumbers].reverse().slice(0,10)" :key="i"
                                :class="i === 0 ? 'bg-red-600 scale-110' : 'bg-slate-800'"
                                class="w-9 h-9 rounded-full flex items-center justify-center text-xs font-black text-white shrink-0">
                                {{ n }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="scroll-area playing-scroll">
                <div v-for="(card, ci) in myCards" :key="ci" class="bg-white p-4 rounded-3xl mb-4 border shadow-sm">
                    <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase mb-2">
                        <span>Ticket #{{ ci + 1 }}</span>
                        <span v-if="isReadyToWin(ci)" class="text-green-600 animate-bounce">READY</span>
                    </div>
                    <div class="loto-grid" :class="{'pointer-events-none opacity-90': isAutoMode}">
                        <template v-for="(row, ri) in card" :key="ri">
                            <div v-for="(cell, ni) in row" :key="ni" 
                                @click="toggleMark(ci, ri, ni)"
                                :class="[cell === 0 ? 'opacity-0' : 'loto-cell', isMarked(ci, ri, ni) ? 'marked' : '']">
                                <span>{{ cell !== 0 ? cell : '' }}</span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="action-tray">
                <div class="flex gap-3 w-full">
                    <button @click="callBingo" class="kinh-btn">{{ t.kinhBtn }}</button>
                    <button v-if="!isAutoMode" @click="drawNextNumber" class="w-24 h-[75px] bg-slate-900 text-white rounded-3xl flex items-center justify-center">
                        <i class="fas fa-step-forward text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div v-if="showInviteModal" class="modal-overlay">
        <div class="modal-body text-center">
            <h3 class="font-black text-xl mb-4">{{ t.inviteTitle }}</h3>
            <p class="text-xs text-slate-400 uppercase font-black mb-2">{{ t.roomIdLabel }}</p>
            <div @click="copyRoomId" class="bg-slate-50 p-4 rounded-2xl font-black text-2xl border-2 border-dashed border-slate-200 cursor-pointer active:scale-95 transition-all">
                {{ roomId }}
            </div>
            <div id="qrcode" class="my-6"></div>
            <p class="text-[10px] font-black text-red-600 animate-pulse mb-6">{{ t.waitingMsg }}</p>
            <button @click="showInviteModal = false" class="w-full h-16 bg-slate-900 text-white rounded-2xl font-black">OK</button>
        </div>
    </div>

    <div v-if="showWalletModal" class="modal-overlay">
        <div class="modal-body text-center">
            <h3 class="font-black text-xl mb-6">{{ t.walletTitle }}</h3>
            <div class="bg-slate-50 p-6 rounded-3xl border mb-6">
                <input type="number" v-model.number="wallet.amount" class="text-4xl font-black text-slate-900 w-full text-center bg-transparent outline-none">
            </div>
            <div class="space-y-4 mb-8">
                <div class="wallet-btn-grid">
                    <button @click="wallet.amount += 100" class="w-tool-btn bg-green-50 text-green-700">+100</button>
                    <button @click="wallet.amount += 1000" class="w-tool-btn bg-green-100 text-green-800">+1K</button>
                    <button @click="wallet.amount += 10000" class="w-tool-btn bg-green-600 text-white">+10K</button>
                </div>
                <div class="wallet-btn-grid">
                    <button @click="wallet.amount = Math.max(0, wallet.amount - 100)" class="w-tool-btn bg-red-50 text-red-700">-100</button>
                    <button @click="wallet.amount = Math.max(0, wallet.amount - 1000)" class="w-tool-btn bg-red-100 text-red-800">-1K</button>
                    <button @click="wallet.amount = Math.max(0, wallet.amount - 10000)" class="w-tool-btn bg-red-600 text-white">-10K</button>
                </div>
            </div>
            <button @click="showWalletModal = false" class="w-full h-14 bg-slate-900 text-white rounded-2xl font-black">DONE</button>
        </div>
    </div>

    <div v-if="showSettingsModal" class="modal-overlay">
        <div class="modal-body">
            <h3 class="font-black text-xl mb-6">Settings</h3>
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-black text-slate-400 block mb-3 uppercase">Language</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button v-for="(l, k) in languages" :key="k" @click="setLang(k)"
                            :class="currentLang === k ? 'border-red-600 bg-red-50' : 'border-slate-100'"
                            class="p-3 border-2 rounded-xl text-[10px] font-bold">{{ l.label }}</button>
                    </div>
                </div>
                <div class="flex items-center justify-between bg-slate-50 p-4 rounded-2xl">
                    <span class="font-black text-sm">Auto Mark</span>
                    <button @click="isAutoMode = !isAutoMode" :class="isAutoMode ? 'bg-green-500' : 'bg-slate-300'" class="w-12 h-7 rounded-full relative transition-all">
                        <div :class="isAutoMode ? 'translate-x-6' : 'translate-x-1'" class="absolute top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
                    </button>
                </div>
            </div>
            <button @click="showSettingsModal = false" class="w-full h-14 bg-slate-900 text-white rounded-2xl font-black mt-8">SAVE</button>
        </div>
    </div>

</div>

<script>
const i18n = {
    ja: { label: "日本語", welcomeTitle: "ロト・オンライン", playerNameLabel: "プレイヤー名", placeholderName: "名前を入力...", modeSolo: "ソロプレイ", modeMulti: "マルチプレイ", setupTitle: "ゲーム設定", opponentsLabel: "対戦相手 (BOT)", ticketQtyLabel: "チケット枚数", betLabel: "賭け金", startBtn: "開始する", kinhBtn: "ビンゴ！", winMsg: "勝利！", loseMsg: "まだです", walletTitle: "ウォレット", historyLabel: "履歴", createRoomBtn: "ルームを作成", placeholderRoom: "ルームIDを入力", inviteTitle: "友達を招待", roomIdLabel: "ルームID (タップでコピー)", waitingMsg: "対戦相手を待機中..." },
    vi: { label: "Tiếng Việt", welcomeTitle: "LOTO ONLINE", playerNameLabel: "TÊN NGƯỜI CHƠI", placeholderName: "Nhập tên...", modeSolo: "CHƠI ĐƠN", modeMulti: "CHƠI NHIỀU NGƯỜI", setupTitle: "CÀI ĐẶT", opponentsLabel: "ĐỐI THỦ (BOT)", ticketQtyLabel: "SỐ VÉ", betLabel: "CƯỢC", startBtn: "BẮT ĐẦU", kinhBtn: "KINH!", winMsg: "THẮNG!", loseMsg: "CHƯA ĐỦ", walletTitle: "VÍ", historyLabel: "LỊCH SỬ", createRoomBtn: "TẠO PHÒNG", placeholderRoom: "Nhập mã phòng", inviteTitle: "MỜI BẠN BÈ", roomIdLabel: "MÃ PHÒNG (CHẠM ĐỂ SAO CHÉP)", waitingMsg: "ĐANG CHỜ ĐỐI THỦ..." },
    en: { label: "English", welcomeTitle: "LOTO ONLINE", playerNameLabel: "PLAYER NAME", placeholderName: "Enter name...", modeSolo: "SOLO", modeMulti: "MULTI", setupTitle: "SETUP", opponentsLabel: "BOTS", ticketQtyLabel: "TICKETS", betLabel: "BET", startBtn: "START", kinhBtn: "BINGO!", winMsg: "WIN!", loseMsg: "NOT YET", walletTitle: "WALLET", historyLabel: "HISTORY", createRoomBtn: "CREATE ROOM", placeholderRoom: "Enter Room ID", inviteTitle: "INVITE FRIENDS", roomIdLabel: "ROOM ID (TAP TO COPY)", waitingMsg: "WAITING FOR OPPONENTS..." },
    cn: { label: "简体中文", welcomeTitle: "在线乐透", playerNameLabel: "玩家名称", placeholderName: "输入名字...", modeSolo: "单人", modeMulti: "多人", setupTitle: "设置", opponentsLabel: "机器人", ticketQtyLabel: "票数", betLabel: "赌注", startBtn: "开始", kinhBtn: "胡了!", winMsg: "赢了!", loseMsg: "还没好", walletTitle: "钱包", historyLabel: "历史", createRoomBtn: "创建房间", placeholderRoom: "输入房间ID", inviteTitle: "邀请好友", roomIdLabel: "房间ID (点击复制)", waitingMsg: "等待对手中..." },
    th: { label: "ไทย", welcomeTitle: "โลโต้ ออนไลน์", playerNameLabel: "ชื่อผู้เล่น", placeholderName: "ใส่ชื่อ...", modeSolo: "เดี่ยว", modeMulti: "กลุ่ม", setupTitle: "ตั้งค่า", opponentsLabel: "บอท", ticketQtyLabel: "ตั๋ว", betLabel: "เดิมพัน", startBtn: "เริ่ม", kinhBtn: "บิงโก!", winMsg: "ชนะ!", loseMsg: "ยังไม่ครบ", walletTitle: "กระเป๋า", historyLabel: "ประวัติ", createRoomBtn: "สร้างห้อง", placeholderRoom: "ใส่รหัสห้อง", inviteTitle: "เชิญเพื่อน", roomIdLabel: "รหัสห้อง (แตะเพื่อคัดลอก)", waitingMsg: "กำลังรอผู้เล่นอื่น..." },
    lo: { label: "ລາວ", welcomeTitle: "ໂລໂຕ ອອນລາຍ", playerNameLabel: "ຊື່ຜູ້ຫຼິ້ນ", placeholderName: "ໃສ່ຊື່...", modeSolo: "ດ່ຽວ", modeMulti: "ກຸ່ມ", setupTitle: "ຕັ້ງຄ່າ", opponentsLabel: "ບັອດ", ticketQtyLabel: "ໃບ", betLabel: "ເດີມພັນ", startBtn: "ເລີ່ມ", kinhBtn: "ຊະນະ!", winMsg: "ຊະນະ!", loseMsg: "ບໍ່ຄົບ", walletTitle: "ກະເປົາ", historyLabel: "ປະຫວັດ", createRoomBtn: "ສ້າງຫ້ອງ", placeholderRoom: "ໃສ່ລະຫັດຫ້ອງ", inviteTitle: "ເຊີນໝູ່", roomIdLabel: "ລະຫັດຫ້ອງ (ແຕະເພື່ອສຳເນົາ)", waitingMsg: "ກຳລັງລໍຖ້າຜູ້ຫຼິ້ນ..." },
    km: { label: "ភាសាខ្មែរ", welcomeTitle: "ឡូតូ អនឡាញ", playerNameLabel: "ឈ្មោះអ្នកលេង", placeholderName: "បញ្ចូលឈ្មោះ...", modeSolo: "ម្នាក់ឯង", modeMulti: "ច្រើននាក់", setupTitle: "កំណត់", opponentsLabel: "បូត", ticketQtyLabel: "សន្លឹក", betLabel: "ភ្នាល់", startBtn: "ចាប់ផ្ដើម", kinhBtn: "ឈ្នះ!", winMsg: "ឈ្នះ!", loseMsg: "មិនទាន់", walletTitle: "កាបូប", historyLabel: "ប្រវត្តិ", createRoomBtn: "បង្កើតបន្ទប់", placeholderRoom: "បញ្ចូលលេខបន្ទប់", inviteTitle: "អញ្ជើញមិត្តភក្តិ", roomIdLabel: "លេខបន្ទប់ (ប៉ះដើម្បីចម្លង)", waitingMsg: "កំពុងរង់ចាំគូប្រកួត..." },
    fr: { label: "Français", welcomeTitle: "LOTO EN LIGNE", playerNameLabel: "NOM", placeholderName: "Entrez...", modeSolo: "SOLO", modeMulti: "MULTI", setupTitle: "RÉGLAGES", opponentsLabel: "BOTS", ticketQtyLabel: "BILLETS", betLabel: "MISE", startBtn: "JOUER", kinhBtn: "BINGO!", winMsg: "GAGNÉ!", loseMsg: "PAS ENCORE", walletTitle: "WALLET", historyLabel: "HISTORIQUE", createRoomBtn: "CRÉER SALLE", placeholderRoom: "Entrer ID", inviteTitle: "INVITER", roomIdLabel: "ID SALLE (CLIQUER)", waitingMsg: "EN ATTENTE..." }
};

const { createApp, ref, reactive, computed, onMounted, watch } = Vue;

createApp({
    setup() {
        const currentLang = ref(localStorage.getItem('loto_lang_v4') || 'ja');
        const gameState = ref('HOME');
        const mode = ref('SOLO');
        const playerName = ref(localStorage.getItem('loto_pname') || '');
        const wallet = reactive({ amount: 10000 });
        
        const ticketQty = ref(1);
        const botCount = ref(3);
        const betAmount = ref(100);
        const isAutoMode = ref(true);
        const drawInterval = ref(3);
        
        const myCards = ref([]);
        const myMarks = ref([]);
        const drawnNumbers = ref([]);
        const currentNumber = ref(null);
        const currentTime = ref('');

        // Multiplayer States
        const roomId = ref('');
        const inputRoomId = ref('');
        const isRoomCreated = ref(false);
        const showInviteModal = ref(false);
        const showSettingsModal = ref(false);
        const showWalletModal = ref(false);
        
        let gameTimer = null;

        const t = computed(() => i18n[currentLang.value]);
        const languages = computed(() => i18n);

        onMounted(() => {
            setInterval(() => { currentTime.value = new Date().toLocaleString(); }, 1000);
        });

        const setLang = (k) => {
            currentLang.value = k;
            localStorage.setItem('loto_lang_v4', k);
        };

        const initSetup = (m) => {
            mode.value = m;
            if(!playerName.value) playerName.value = "User" + Math.floor(Math.random()*1000);
            localStorage.setItem('loto_pname', playerName.value);
            isRoomCreated.value = false;
            gameState.value = 'SETUP';
        };

        const createRoom = () => {
            roomId.value = Math.random().toString(36).substring(2, 8).toUpperCase();
            isRoomCreated.value = true;
            showInviteModal.value = true;
            // QRコード生成 (VueのDOM更新後に実行)
            setTimeout(() => {
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), {
                    text: window.location.href + "?room=" + roomId.value,
                    width: 150, height: 150
                });
            }, 100);
        };

        const joinRoom = () => {
            if(!inputRoomId.value) return;
            roomId.value = inputRoomId.value.toUpperCase();
            isRoomCreated.value = true;
        };

        const copyRoomId = () => {
            navigator.clipboard.writeText(roomId.value);
            alert("Room ID Copied!");
        };

        const startGame = () => {
            if(wallet.amount < (betAmount.value * ticketQty.value)) return alert("Balance low!");
            wallet.amount -= (betAmount.value * ticketQty.value);
            generateCards();
            drawnNumbers.value = [];
            currentNumber.value = null;
            gameState.value = 'PLAYING';
            if(isAutoMode.value) startTimer();
        };

        const generateCards = () => {
            const cards = []; const marks = [];
            for(let i=0; i<ticketQty.value; i++) {
                const card = Array(3).fill(0).map(() => Array(9).fill(0));
                const ranges = [[1,9],[10,19],[20,29],[30,39],[40,49],[50,59],[60,69],[70,79],[80,90]];
                for(let r=0; r<3; r++) {
                    const cols = [0,1,2,3,4,5,6,7,8].sort(()=>Math.random()-0.5).slice(0,5).sort();
                    cols.forEach(c => {
                        let n; do { n = Math.floor(Math.random()*(ranges[c][1]-ranges[c][0]+1))+ranges[c][0]; }
                        while(card[0][c]===n || card[1][c]===n);
                        card[r][c] = n;
                    });
                }
                cards.push(card); marks.push(Array(3).fill(0).map(()=>Array(9).fill(false)));
            }
            myCards.value = cards; myMarks.value = marks;
        };

        const startTimer = () => {
            if(gameTimer) clearInterval(gameTimer);
            gameTimer = setInterval(drawNextNumber, drawInterval.value * 1000);
        };

        const drawNextNumber = () => {
            if(drawnNumbers.value.length >= 90) return clearInterval(gameTimer);
            let n; do { n = Math.floor(Math.random()*90)+1; } while(drawnNumbers.value.includes(n));
            currentNumber.value = n; drawnNumbers.value.push(n);
            if(isAutoMode.value) {
                myCards.value.forEach((c, ci) => c.forEach((r, ri) => r.forEach((num, ni) => {
                    if(num === n) myMarks.value[ci][ri][ni] = true;
                })));
            }
        };

        const toggleMark = (ci, ri, ni) => {
            if(isAutoMode.value) return;
            const v = myCards.value[ci][ri][ni];
            if(v !== 0 && drawnNumbers.value.includes(v)) myMarks.value[ci][ri][ni] = !myMarks.value[ci][ri][ni];
        };

        const isReadyToWin = (ci) => myMarks.value[ci].some(row => row.filter(m => m).length === 5);

        const callBingo = () => {
            const win = myMarks.value.some((m, ci) => m.some((row, ri) => 
                row.filter((mark, ni) => mark && drawnNumbers.value.includes(myCards.value[ci][ri][ni])).length === 5
            ));
            if(win) { alert(t.value.winMsg); wallet.amount += betAmount.value * 12; backToHome(); }
            else { alert(t.value.loseMsg); }
        };

        const backToHome = () => { if(gameTimer) clearInterval(gameTimer); gameState.value = 'HOME'; };

        return {
            currentLang, gameState, mode, playerName, wallet, ticketQty, botCount, betAmount, isAutoMode, drawInterval,
            myCards, myMarks, drawnNumbers, currentNumber, currentTime, roomId, inputRoomId, isRoomCreated,
            showInviteModal, showSettingsModal, showWalletModal, t, languages,
            setLang, initSetup, createRoom, joinRoom, copyRoomId, startGame, drawNextNumber, toggleMark, isReadyToWin, callBingo, backToHome,
            isMarked: (c,r,n) => myMarks.value[c][r][n]
        };
    }
}).mount('#app');
</script>
</body>
</html>
